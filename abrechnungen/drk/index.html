<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datensätze - RB Inside Office</title>
    <!-- Zentrale Styles -->
    <link rel="stylesheet" href="../../css/styles.css">
    <script src="../../js/main.js"></script>
    <!-- Zentrale Scripts -->
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- SheetJS für Excel/CSV Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Seiten-spezifische Styles (nur wenn nötig) */
        body {
            background: var(--bg-secondary);
        }
        /* Dropdown-Optionen Stornieren und Löschen ausblenden */
        .dropdown-item.warning,
        .dropdown-item.danger,
        .dropdown-item.warning + .dropdown-divider,
        .dropdown-divider:has(+ .dropdown-item.warning) {
            display: none;
        }

        /* Abrechnung Modal Styles */
        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-primary);
            border-radius: var(--radius-xs);
            cursor: pointer;
        }
        .checkbox-item:hover {
            background: var(--bg-hover);
        }
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-color);
        }
        .checkbox-label {
            flex: 1;
            font-size: var(--text-normal);
        }
        .checkbox-info {
            color: var(--text-secondary);
        }

        /* Vorschau Styles */
        .vorschau-summary {
            margin-bottom: var(--spacing-md);
        }
        .vorschau-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        .vorschau-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .vorschau-stats {
            display: flex;
            gap: var(--spacing-lg);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }
        .vorschau-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .vorschau-table-container {
            overflow-x: auto;
        }
        .table-section-header td {
            background: var(--bg-secondary);
            padding-top: var(--spacing-md) !important;
        }
        .table-sum-row td {
            border-top: 1px solid var(--border-color);
            padding-top: var(--spacing-sm) !important;
        }
        .table-total-row td {
            background: var(--bg-secondary);
            font-size: var(--text-normal);
        }
        .text-error {
            color: var(--error);
        }
    </style>
</head>
<body class="datensaetze-page">
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-row">
            <div class="page-header-links">
                <span class="text-ueberschrift-unterabschnitt">DRK</span>
            </div>
            <div class="page-header-mitte">
                <span class="text-ueberschrift">Abrechnungen</span>
            </div>
        </div>
        <!-- Lokale Tabs (per Klick navigierbar) -->
        <div class="page-header-tabs" id="datensaetzeSubTabs">
            <div class="kw-tab active" data-tab="records">Kunden <span class="tab-badge" id="recordsBadge">0</span></div>
            <div class="kw-tab" data-tab="rechnungen">Rechnungen <span class="tab-badge" id="rechnungenBadge">0</span></div>
            <div class="kw-tab" data-tab="faellig">Fällig <span class="tab-badge" id="faelligBadge">0</span></div>
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-content page-content--table">

            <!-- NEUMITGLIEDER / ERHÖHUNGEN TAB -->
            <div class="kw-tab-content active" id="tab-records">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Anzeigenfeld 1: Filter -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--min-height">
                            <button class="btn btn-sm active" data-filter="all" onclick="setFilter('all')">Alle</button>
                            <button class="btn btn-sm" data-filter="offenerVorschuss" onclick="setFilter('offenerVorschuss')">Offener Vorschuss</button>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--divider"></div>
                        <!-- Anzeigenfeld 2: Auswahl-Aktionen (erscheint bei Selektion) -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden" id="recordsSelectionGroup">
                            <span class="btn btn-sm" id="recordsSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="recordsSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMail('records')">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="createAbrechnung('records')">
                                <span class="icon icon--dokument"></span>
                                Abrechnung erstellen
                            </button>
                        </div>
                        <!-- Spacer -->
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Anzeigenfeld 3: Spalten & Audit (rechts) -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('records')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                            <button class="btn btn-sm" onclick="openAuditModal('nmg-erh', 'default')">
                                <span class="icon icon--uhr"></span>
                                Audit
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="recordsTable">
                            <thead id="recordsTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                            <tfoot id="recordsTableFoot">
                                <!-- Wird dynamisch gerendert -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RECHNUNGEN TAB -->
            <div class="kw-tab-content" id="tab-rechnungen">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Filter -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--min-height">
                            <select class="btn btn-sm" id="filterRechnungStatus" onchange="filterRechnungen()">
                                <option value="all">Alle Status</option>
                                <option value="entwurf">Entwurf</option>
                                <option value="offen">Offen</option>
                                <option value="geplant">Geplant</option>
                                <option value="bezahlt">Bezahlt</option>
                                <option value="storniert">Storniert</option>
                            </select>
                            <select class="btn btn-sm" id="filterRechnungTyp" onchange="filterRechnungen()">
                                <option value="all">Alle Typen</option>
                                <option value="ZA">Zwischenabrechnung</option>
                                <option value="EA">Endabrechnung</option>
                                <option value="1JA">1. Jahresabrechnung</option>
                                <option value="2JA">2. Jahresabrechnung</option>
                                <option value="3JA">3. Jahresabrechnung</option>
                                <option value="4JA">4. Jahresabrechnung</option>
                            </select>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--divider"></div>
                        <!-- Auswahl-Aktionen -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden" id="rechnungenSelectionGroup">
                            <span class="btn btn-sm" id="rechnungenSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="rechnungenSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMailRechnungen()">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="downloadPdfZip()">
                                <span class="icon icon--dokument"></span>
                                PDF (ZIP)
                            </button>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Rechts -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('rechnungen')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="rechnungenTable">
                            <thead id="rechnungenTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="rechnungenTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FÄLLIG TAB -->
            <div class="kw-tab-content" id="tab-faellig">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Auswahl-Aktionen -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden anzeigenfeld--min-height" id="faelligSelectionGroup">
                            <span class="btn btn-sm" id="faelligSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="faelligSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm btn-primary" onclick="createAbrechnungFromFaellig()">
                                <span class="icon icon--dokument"></span>
                                Abrechnung erstellen
                            </button>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="faelligTable">
                            <thead id="faelligTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="faelligTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
    </div><!-- Ende page-content -->
</div><!-- Ende page-container -->

<!-- Storno Modal (aus zentralem Template) -->
    <!-- Wird durch ModalTemplates.init(['storno']) erstellt -->

    <!-- Alle Modals werden durch ModalTemplates.init() erstellt -->
    <!-- Verfügbar: storno, columns, edit, import, export -->

<!-- Abrechnung erstellen Modal -->
<div class="modal modal-l" id="abrechnungModal">
    <div class="page-container page-container--modal">
        <!-- Modal Header -->
        <div class="page-header">
            <div class="page-header-row">
                <div class="page-header-links">
                    <span class="text-ueberschrift">Abrechnung erstellen</span>
                    <span class="text-klein" id="abrechnungModalSubtitle">Schritt 1: Auswahl</span>
                </div>
                <div class="page-header-mitte"></div>
                <div class="page-header-rechts">
                    <button class="btn btn-icon" onclick="closeAbrechnungModal()">
                        <span class="icon icon--schliessen"></span>
                    </button>
                </div>
            </div>
            <div class="page-header-tabs">
                <div class="kw-tab active" data-tab="auswahl" id="tabAuswahl">1. Auswahl</div>
                <div class="kw-tab" data-tab="vorschau" id="tabVorschau">2. Vorschau</div>
            </div>
        </div>

        <!-- Schritt 1: Auswahl -->
        <div class="page-content page-content--modal" id="abrechnungStep1">
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Kunde</label>
                    <select class="eingabefeld" id="abrKunde" onchange="loadKampagnenForKunde()">
                        <option value="">Bitte auswählen...</option>
                    </select>
                    <span class="eingabefeld-beschriftung-unten" id="abrKundeInfo"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Kampagne</label>
                    <select class="eingabefeld" id="abrKampagne" onchange="loadEinsatzgebiete()" disabled>
                        <option value="">Erst Kunde wählen...</option>
                    </select>
                    <span class="eingabefeld-beschriftung-unten" id="abrKampagneInfo"></span>
                </div>
            </div>
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Abrechnungstyp</label>
                    <select class="eingabefeld" id="abrTyp" onchange="updateStornopufferVisibility()">
                        <option value="ZA">Zwischenabrechnung (ZA)</option>
                        <option value="EA">Endabrechnung (EA)</option>
                        <option value="1JA">1. Jahresabrechnung (VJ2)</option>
                        <option value="2JA">2. Jahresabrechnung (VJ3)</option>
                        <option value="3JA">3. Jahresabrechnung (VJ4)</option>
                        <option value="4JA">4. Jahresabrechnung (VJ5)</option>
                    </select>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Vertragsnummer</label>
                    <select class="eingabefeld" id="abrVertrag" disabled>
                        <option value="">Erst Kunde wählen...</option>
                    </select>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Zeitraum von</label>
                    <input type="date" class="eingabefeld" id="abrZeitraumVon">
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Zeitraum bis</label>
                    <input type="date" class="eingabefeld" id="abrZeitraumBis">
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Einsatzgebiete</label>
                    <div class="checkbox-list" id="abrEinsatzgebiete">
                        <div class="text-klein text-secondary">Erst Kampagne wählen...</div>
                    </div>
                    <span class="eingabefeld-beschriftung-unten" id="abrEinsatzgebieteInfo"></span>
                </div>
            </div>
        </div>

        <!-- Schritt 2: Vorschau -->
        <div class="page-content page-content--modal" id="abrechnungStep2" style="display: none;">
            <div class="vorschau-summary" id="vorschauSummary">
                <!-- Wird dynamisch gefüllt -->
            </div>
            <div class="vorschau-table-container">
                <table class="table table--compact" id="vorschauTable">
                    <thead>
                        <tr>
                            <th class="text-left">Position</th>
                            <th class="text-left">Beschreibung</th>
                            <th class="text-right">MG</th>
                            <th class="text-right">JE (€)</th>
                            <th class="text-center">%</th>
                            <th class="text-right">Betrag (€)</th>
                        </tr>
                    </thead>
                    <tbody id="vorschauTableBody">
                        <!-- Wird dynamisch gefüllt -->
                    </tbody>
                    <tfoot id="vorschauTableFoot">
                        <!-- Wird dynamisch gefüllt -->
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="page-footer">
            <button class="btn btn-secondary" id="abrBtnZurueck" onclick="abrechnungZurueck()" style="display: none;">Zurück</button>
            <div class="anzeigenfeld--spacer"></div>
            <button class="btn btn-secondary" onclick="closeAbrechnungModal()">Abbrechen</button>
            <button class="btn btn-primary" id="abrBtnWeiter" onclick="abrechnungWeiter()">Weiter</button>
            <button class="btn btn-secondary" id="abrBtnEntwurf" onclick="saveAbrechnungEntwurf()" style="display: none;">Als Entwurf</button>
            <button class="btn btn-primary" id="abrBtnErstellen" onclick="saveAbrechnungErstellen()" style="display: none;">Erstellen</button>
        </div>
    </div>
</div>

    <!-- Seiten-spezifische Daten und Initialisierung -->
    <script>
        // ========== TEST DATA ==========
        const testRecordsData = [
            { id: 1, name: 'DRK KV Frankfurt', kundenId: 'DRK-001', rechnungsnummer: 'RE-2025-0001', auftragsnummer: 'A-2025-001', offeneProv1Jahr: '1.250,00 €', stornopufferProzent: '10%', stornopufferSumme: '125,00 €', offeneProv2Jahr: '800,00 €', offeneProv3Jahr: '600,00 €', offeneProv4Jahr: '400,00 €', offeneProv5Jahr: '200,00 €', provisionGesamt: '3.250,00 €', mitglieder: 125, jahreseuros: '15.000,00 €' },
            { id: 2, name: 'DRK KV Darmstadt', kundenId: 'DRK-002', rechnungsnummer: 'RE-2025-0002', auftragsnummer: 'A-2025-002', offeneProv1Jahr: '980,00 €', stornopufferProzent: '10%', stornopufferSumme: '98,00 €', offeneProv2Jahr: '650,00 €', offeneProv3Jahr: '450,00 €', offeneProv4Jahr: '300,00 €', offeneProv5Jahr: '150,00 €', provisionGesamt: '2.530,00 €', mitglieder: 98, jahreseuros: '11.760,00 €' },
            { id: 3, name: 'DRK KV Wiesbaden', kundenId: 'DRK-003', rechnungsnummer: 'RE-2025-0003', auftragsnummer: 'A-2025-003', offeneProv1Jahr: '1.540,00 €', stornopufferProzent: '12%', stornopufferSumme: '184,80 €', offeneProv2Jahr: '920,00 €', offeneProv3Jahr: '720,00 €', offeneProv4Jahr: '480,00 €', offeneProv5Jahr: '240,00 €', provisionGesamt: '3.900,00 €', mitglieder: 154, jahreseuros: '18.480,00 €' },
            { id: 4, name: 'DRK KV Offenbach', kundenId: 'DRK-004', rechnungsnummer: 'RE-2025-0004', auftragsnummer: 'A-2025-004', offeneProv1Jahr: '720,00 €', stornopufferProzent: '10%', stornopufferSumme: '72,00 €', offeneProv2Jahr: '480,00 €', offeneProv3Jahr: '360,00 €', offeneProv4Jahr: '240,00 €', offeneProv5Jahr: '120,00 €', provisionGesamt: '1.920,00 €', mitglieder: 72, jahreseuros: '8.640,00 €' },
            { id: 5, name: 'DRK KV Kassel', kundenId: 'DRK-005', rechnungsnummer: 'RE-2025-0005', auftragsnummer: 'A-2025-005', offeneProv1Jahr: '1.890,00 €', stornopufferProzent: '15%', stornopufferSumme: '283,50 €', offeneProv2Jahr: '1.100,00 €', offeneProv3Jahr: '850,00 €', offeneProv4Jahr: '600,00 €', offeneProv5Jahr: '350,00 €', provisionGesamt: '4.790,00 €', mitglieder: 189, jahreseuros: '22.680,00 €' },
            { id: 6, name: 'DRK KV Gießen', kundenId: 'DRK-006', rechnungsnummer: 'RE-2025-0006', auftragsnummer: 'A-2025-006', offeneProv1Jahr: '560,00 €', stornopufferProzent: '10%', stornopufferSumme: '56,00 €', offeneProv2Jahr: '380,00 €', offeneProv3Jahr: '280,00 €', offeneProv4Jahr: '180,00 €', offeneProv5Jahr: '90,00 €', provisionGesamt: '1.490,00 €', mitglieder: 56, jahreseuros: '6.720,00 €' },
            { id: 7, name: 'DRK KV Fulda', kundenId: 'DRK-007', rechnungsnummer: 'RE-2025-0007', auftragsnummer: 'A-2025-007', offeneProv1Jahr: '830,00 €', stornopufferProzent: '10%', stornopufferSumme: '83,00 €', offeneProv2Jahr: '550,00 €', offeneProv3Jahr: '420,00 €', offeneProv4Jahr: '280,00 €', offeneProv5Jahr: '140,00 €', provisionGesamt: '2.220,00 €', mitglieder: 83, jahreseuros: '9.960,00 €' },
            { id: 8, name: 'DRK KV Marburg', kundenId: 'DRK-008', rechnungsnummer: 'RE-2025-0008', auftragsnummer: 'A-2025-008', offeneProv1Jahr: '1.120,00 €', stornopufferProzent: '12%', stornopufferSumme: '134,40 €', offeneProv2Jahr: '740,00 €', offeneProv3Jahr: '560,00 €', offeneProv4Jahr: '380,00 €', offeneProv5Jahr: '190,00 €', provisionGesamt: '2.990,00 €', mitglieder: 112, jahreseuros: '13.440,00 €' },
        ];

        // Test-Daten für Rechnungen
        const testRechnungenData = [
            { id: 'r1', rechnungsnummer: '26-OV-001-ZA-00001', kunde: 'DRK KV Frankfurt', typ: 'ZA', brutto: '5.708,00 €', status: 'bezahlt', datum: '15.01.2026' },
            { id: 'r2', rechnungsnummer: '26-OV-002-ZA-00002', kunde: 'DRK KV Darmstadt', typ: 'ZA', brutto: '3.245,00 €', status: 'offen', datum: '18.01.2026' },
            { id: 'r3', rechnungsnummer: '26-KV-003-EA-00003', kunde: 'DRK KV Wiesbaden', typ: 'EA', brutto: '8.920,00 €', status: 'geplant', datum: '20.01.2026' },
            { id: 'r4', rechnungsnummer: '26-OV-004-1JA-00004', kunde: 'DRK KV Offenbach', typ: '1JA', brutto: '4.560,00 €', status: 'entwurf', datum: '20.01.2026' },
        ];

        // Test-Daten für Fällige Abrechnungen
        const testFaelligData = [
            { id: 'f1', kunde: 'DRK KV Kassel', kampagne: 'Frühjahr 2025', typ: 'EA', faelligSeit: '10.01.2026', betragCa: '6.200,00 €' },
            { id: 'f2', kunde: 'DRK KV Gießen', kampagne: 'Herbst 2024', typ: '1JA', faelligSeit: '05.01.2026', betragCa: '3.800,00 €' },
            { id: 'f3', kunde: 'DRK KV Fulda', kampagne: 'Sommer 2024', typ: '2JA', faelligSeit: '01.01.2026', betragCa: '2.100,00 €' },
        ];

        const testHistoryData = {
            1: [
                { type: 'neumitglied', date: '10.12.2025', title: 'Mitglied geworden', detail: 'Beitrag: 10,00 € monatlich' },
            ],
            101: [
                { type: 'neumitglied', date: '15.03.2023', title: 'Mitglied geworden', detail: 'Beitrag: 3,00 € monatlich' },
                { type: 'erhoehung', date: '10.12.2025', title: 'Beitrag erhöht', detail: 'Von 3,00 € auf 10,00 € monatlich' },
            ],
            201: [
                { type: 'neumitglied', date: '15.03.2019', title: 'Mitglied geworden', detail: 'Beitrag: 5,00 € monatlich' },
                { type: 'erhoehung', date: '01.01.2021', title: 'Beitrag erhöht', detail: 'Von 5,00 € auf 8,00 € monatlich' },
                { type: 'aenderung', date: '15.06.2022', title: 'Adresse geändert', detail: 'Neue Adresse: Musterstr. 12' },
                { type: 'erhoehung', date: '01.01.2024', title: 'Beitrag erhöht', detail: 'Von 8,00 € auf 10,00 € monatlich' },
            ],
            4: [
                { type: 'neumitglied', date: '07.12.2025', title: 'Mitglied geworden', detail: 'Beitrag: 10,00 € monatlich' },
                { type: 'storno', date: '09.12.2025', title: 'Storniert', detail: 'Grund: Widerruf' },
            ],
        };

        // Kontext-Daten (würde normalerweise von URL-Parameter oder API kommen)
        const contextData = {
            type: 'kunde',  // 'werber', 'kunde', 'werbegebiet', 'kampagne'
            name: 'DRK KV Ludwigshafen'
        };

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Tabs initialisieren
            initTabs('.kw-tab', '.kw-tab-content');

            // Zentrale Modals initialisieren
            ModalTemplates.init(['storno', 'columns', 'edit', 'import', 'export']);

            // Abrechnungs-eigene Render-Funktion (überschreibt die aus main.js)
            window.renderRecordsTable = renderAbrechnungenTable;

            // Datensätze-System initialisieren mit Test-Daten
            initDatensaetze({
                recordsData: testRecordsData,
                bestandData: testBestandData,
                historyData: testHistoryData,
                contextData: contextData
            });

            // Tab-Badges aktualisieren
            document.getElementById('recordsBadge').textContent = testRecordsData.length;
            document.getElementById('rechnungenBadge').textContent = testRechnungenData.filter(r => r.status === 'offen').length;
            document.getElementById('faelligBadge').textContent = testFaelligData.length;

            // Neue Tabs rendern
            renderRechnungenTable();
            renderFaelligTable();

            // Register toolbar config with shell (Import/Export for data tables)
            registerToolbarConfig();
        });

        // Abrechnungs-spezifische Render-Funktion (Kopie aus main.js mit zusätzlichen Spalten)
        function renderAbrechnungenTable() {
            let filtered;
            if (currentFilter === 'all') {
                filtered = recordsData;
            } else if (currentFilter === 'offenerVorschuss') {
                // Zeigt Einträge mit offenem Vorschuss (Wert > 0)
                filtered = recordsData.filter(d => {
                    const val = parseFloat(String(d.offenerVorschuss || '0').replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                    return val > 0;
                });
            } else {
                filtered = recordsData.filter(d => d.typ === currentFilter);
            }

            // DRK-spezifische Spalten-Konfiguration
            const config = [
                { id: 'name', visible: true },
                { id: 'kundenId', visible: true },
                { id: 'rechnungsnummer', visible: true },
                { id: 'auftragsnummer', visible: true },
                { id: 'offeneProv1Jahr', visible: true },
                { id: 'stornopufferProzent', visible: true },
                { id: 'stornopufferSumme', visible: true },
                { id: 'offeneProv2Jahr', visible: true },
                { id: 'offeneProv3Jahr', visible: true },
                { id: 'offeneProv4Jahr', visible: true },
                { id: 'offeneProv5Jahr', visible: true },
                { id: 'provisionGesamt', visible: true },
                { id: 'mitglieder', visible: true },
                { id: 'jahreseuros', visible: true }
            ];

            // Header-Definitionen für DRK-Abrechnungen
            const headerDefs = {
                name: { class: 'col-name text-left', label: 'Name' },
                kundenId: { class: 'col-m text-left', label: 'Kunden ID' },
                rechnungsnummer: { class: 'col-m text-left', label: 'Rechnungsnummer' },
                auftragsnummer: { class: 'col-m text-left', label: 'Auftr. / Vertr.-Nr.' },
                offeneProv1Jahr: { class: 'col-m text-right', label: 'Offene Prov. 1. Jahr' },
                stornopufferProzent: { class: 'col-s text-right', label: 'Stornopuffer (%)' },
                stornopufferSumme: { class: 'col-m text-right', label: 'Stornopuffer Summe' },
                offeneProv2Jahr: { class: 'col-m text-right', label: 'Offene Prov. 2. Jahr' },
                offeneProv3Jahr: { class: 'col-m text-right', label: 'Offene Prov. 3. Jahr' },
                offeneProv4Jahr: { class: 'col-m text-right', label: 'Offene Prov. 4. Jahr' },
                offeneProv5Jahr: { class: 'col-m text-right', label: 'Offene Prov. 5. Jahr' },
                provisionGesamt: { class: 'col-m text-right', label: 'Provision gesamt' },
                mitglieder: { class: 'col-s text-right', label: 'Mitglieder' },
                jahreseuros: { class: 'col-m text-right', label: 'Jahreseuros' }
            };

            // Header rendern
            const sort = currentSort.records;
            const thead = document.getElementById('recordsTableHead');
            if (!thead) return;

            let headerHtml = `<tr>
                <th class="checkbox-cell">
                    <input type="checkbox" class="row-checkbox" id="selectAllRecords" onclick="TableCheckbox.toggleSelectAll(this, 'recordsTableBody'); updateSelectionUI('recordsTableBody')">
                </th>
                <th class="action-cell"></th>`;

            config.forEach(col => {
                const def = headerDefs[col.id];
                if (def) {
                    const display = col.visible ? '' : 'display:none;';
                    const sortClass = sort.col === col.id ? (sort.direction === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                    headerHtml += `<th class="sortable ${def.class} ${sortClass}" data-col="${col.id}" style="${display}" onclick="sortTable('records', '${col.id}')">
                        ${def.label}
                        <span class="sort-arrows">
                            <span class="icon icon--pfeil-auf arrow-up"></span>
                            <span class="icon icon--pfeil-ab arrow-down"></span>
                        </span>
                    </th>`;
                }
            });
            headerHtml += `<th class="col-spacer"></th></tr>`;
            thead.innerHTML = headerHtml;

            const body = document.getElementById('recordsTableBody');
            if (!body) return;

            body.innerHTML = filtered.map(d => {
                // DRK-spezifische Spalten-Daten
                const colData = {
                    name: { class: 'col-name text-left', html: d.name },
                    kundenId: { class: 'col-m text-left', html: d.kundenId || '-' },
                    rechnungsnummer: { class: 'col-m text-left', html: d.rechnungsnummer || '-' },
                    auftragsnummer: { class: 'col-m text-left', html: d.auftragsnummer || '-' },
                    offeneProv1Jahr: { class: 'col-m text-right', html: d.offeneProv1Jahr || '-' },
                    stornopufferProzent: { class: 'col-s text-right', html: d.stornopufferProzent || '-' },
                    stornopufferSumme: { class: 'col-m text-right', html: d.stornopufferSumme || '-' },
                    offeneProv2Jahr: { class: 'col-m text-right', html: d.offeneProv2Jahr || '-' },
                    offeneProv3Jahr: { class: 'col-m text-right', html: d.offeneProv3Jahr || '-' },
                    offeneProv4Jahr: { class: 'col-m text-right', html: d.offeneProv4Jahr || '-' },
                    offeneProv5Jahr: { class: 'col-m text-right', html: d.offeneProv5Jahr || '-' },
                    provisionGesamt: { class: 'col-m text-right', html: d.provisionGesamt || '-' },
                    mitglieder: { class: 'col-s text-right', html: d.mitglieder || '0' },
                    jahreseuros: { class: 'col-m text-right', html: d.jahreseuros || '-' }
                };

                // Spalten in konfigurierter Reihenfolge rendern
                let columnsHtml = '';
                config.forEach(col => {
                    const data = colData[col.id];
                    if (data) {
                        const display = col.visible ? '' : 'display:none;';
                        columnsHtml += `<td class="${data.class}" style="${display}">${data.html}</td>`;
                    }
                });

                return `
                <tr data-id="${d.id}" data-typ="${d.typ}">
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" onchange="handleRowCheckbox(this, 'records', ${d.id})">
                    </td>
                    <td class="action-cell">
                        <div class="dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown(this, 'records', ${d.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" onclick="handleDropdownAction('edit', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Bearbeiten
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" onclick="handleDropdownAction('mail', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    E-Mail senden
                                </div>
                                <div class="dropdown-item" onclick="handleDropdownAction('pdf', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    PDF Download
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" onclick="handleDropdownAction('createInvoice', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Abrechnung erstellen
                                </div>
                                <div class="dropdown-item" onclick="handleDropdownAction('showInvoices', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                    Rechnungen anzeigen
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item warning" onclick="handleDropdownAction('storno', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                    </svg>
                                    Stornieren
                                </div>
                                <div class="dropdown-item danger" onclick="handleDropdownAction('delete', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Löschen
                                </div>
                            </div>
                        </div>
                    </td>
                    ${columnsHtml}
                    <td class="col-spacer"></td>
                </tr>
            `;
            }).join('');

            // Totals-Row rendern
            renderAbrechnungenTotals(filtered, config);
        }

        // DRK-spezifische Totals-Funktion
        function renderAbrechnungenTotals(data, config) {
            const tfoot = document.getElementById('recordsTableFoot');
            if (!tfoot) return;

            // Summen berechnen
            const parseEuro = (val) => {
                if (typeof val === 'number') return val;
                return parseFloat(String(val || '0').replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            };

            const totalProv1 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv1Jahr), 0);
            const totalStornopuffer = data.reduce((sum, d) => sum + parseEuro(d.stornopufferSumme), 0);
            const totalProv2 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv2Jahr), 0);
            const totalProv3 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv3Jahr), 0);
            const totalProv4 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv4Jahr), 0);
            const totalProv5 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv5Jahr), 0);
            const totalProvGesamt = data.reduce((sum, d) => sum + parseEuro(d.provisionGesamt), 0);
            const totalMitglieder = data.reduce((sum, d) => sum + (parseInt(d.mitglieder) || 0), 0);
            const totalJahreseuros = data.reduce((sum, d) => sum + parseEuro(d.jahreseuros), 0);

            const formatEuro = (val) => val.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';

            // Totals-Definitionen für DRK
            const totalsDefs = {
                name: { class: 'col-name text-left', html: `Gesamt<span class="totals-count">(${data.length})</span>` },
                kundenId: { class: 'col-m text-left', html: '' },
                rechnungsnummer: { class: 'col-m text-left', html: '' },
                auftragsnummer: { class: 'col-m text-left', html: '' },
                offeneProv1Jahr: { class: 'col-m text-right', html: formatEuro(totalProv1) },
                stornopufferProzent: { class: 'col-s text-right', html: '' },
                stornopufferSumme: { class: 'col-m text-right', html: formatEuro(totalStornopuffer) },
                offeneProv2Jahr: { class: 'col-m text-right', html: formatEuro(totalProv2) },
                offeneProv3Jahr: { class: 'col-m text-right', html: formatEuro(totalProv3) },
                offeneProv4Jahr: { class: 'col-m text-right', html: formatEuro(totalProv4) },
                offeneProv5Jahr: { class: 'col-m text-right', html: formatEuro(totalProv5) },
                provisionGesamt: { class: 'col-m text-right', html: formatEuro(totalProvGesamt) },
                mitglieder: { class: 'col-s text-right', html: totalMitglieder.toString() },
                jahreseuros: { class: 'col-m text-right', html: formatEuro(totalJahreseuros) }
            };

            let totalsHtml = '<tr class="totals-row">';
            totalsHtml += '<td class="checkbox-cell"></td>';
            totalsHtml += '<td class="action-cell"></td>';

            config.forEach(col => {
                const def = totalsDefs[col.id];
                if (def) {
                    const display = col.visible ? '' : 'display:none;';
                    totalsHtml += `<td class="${def.class}" style="${display}">${def.html}</td>`;
                }
            });
            totalsHtml += '<td class="col-spacer"></td></tr>';
            tfoot.innerHTML = totalsHtml;
        }

        // Register toolbar buttons for data tables
        function registerToolbarConfig() {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'registerToolbar',
                    config: {
                        actionButtons: [
                            { id: 'import', text: 'Import', icon: 'upload', action: 'openImportModal' },
                            { id: 'export', text: 'Export', icon: 'download', action: 'openExportModal', primary: true }
                        ]
                    }
                }, '*');
            }
        }

        // Listen for toolbar actions from shell
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'toolbarAction') {
                if (e.data.action === 'openImportModal' && typeof openImportModal === 'function') {
                    openImportModal();
                } else if (e.data.action === 'openExportModal' && typeof openExportModal === 'function') {
                    openExportModal();
                }
            }
        });

        // ========== RECHNUNGEN TAB ==========
        function renderRechnungenTable() {
            const thead = document.getElementById('rechnungenTableHead');
            const tbody = document.getElementById('rechnungenTableBody');
            if (!thead || !tbody) return;

            // Filter anwenden
            const statusFilter = document.getElementById('filterRechnungStatus')?.value || 'all';
            const typFilter = document.getElementById('filterRechnungTyp')?.value || 'all';

            let filtered = testRechnungenData;
            if (statusFilter !== 'all') filtered = filtered.filter(r => r.status === statusFilter);
            if (typFilter !== 'all') filtered = filtered.filter(r => r.typ === typFilter);

            // Header
            thead.innerHTML = `<tr>
                <th class="checkbox-cell"><input type="checkbox" class="row-checkbox" onclick="toggleSelectAllRechnungen(this)"></th>
                <th class="action-cell"></th>
                <th class="col-m text-left">Rechnungsnr.</th>
                <th class="col-name text-left">Kunde</th>
                <th class="col-s text-center">Typ</th>
                <th class="col-m text-right">Brutto</th>
                <th class="col-s text-center">Status</th>
                <th class="col-s text-left">Datum</th>
                <th class="col-spacer"></th>
            </tr>`;

            // Body
            tbody.innerHTML = filtered.map(r => {
                const statusClass = {
                    'entwurf': 'badge--neutral',
                    'offen': 'badge--warning',
                    'geplant': 'badge--info',
                    'bezahlt': 'badge--success',
                    'storniert': 'badge--danger'
                }[r.status] || '';

                return `<tr data-id="${r.id}">
                    <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" onchange="updateRechnungenSelection()"></td>
                    <td class="action-cell">
                        <div class="dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown(this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" onclick="openRechnungDetails('${r.id}')">Details anzeigen</div>
                                <div class="dropdown-item" onclick="downloadRechnungPdf('${r.id}')">PDF Download</div>
                                <div class="dropdown-item" onclick="sendRechnungEmail('${r.id}')">E-Mail senden</div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" onclick="erfasseZahlung('${r.id}')">Zahlung erfassen</div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item warning" onclick="storniereRechnung('${r.id}')">Stornieren</div>
                            </div>
                        </div>
                    </td>
                    <td class="col-m text-left">${r.rechnungsnummer}</td>
                    <td class="col-name text-left">${r.kunde}</td>
                    <td class="col-s text-center"><span class="badge badge--small">${r.typ}</span></td>
                    <td class="col-m text-right">${r.brutto}</td>
                    <td class="col-s text-center"><span class="badge badge--small ${statusClass}">${r.status}</span></td>
                    <td class="col-s text-left">${r.datum}</td>
                    <td class="col-spacer"></td>
                </tr>`;
            }).join('');
        }

        function filterRechnungen() {
            renderRechnungenTable();
        }

        function toggleSelectAllRechnungen(checkbox) {
            const checkboxes = document.querySelectorAll('#rechnungenTableBody .row-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateRechnungenSelection();
        }

        function updateRechnungenSelection() {
            const checkboxes = document.querySelectorAll('#rechnungenTableBody .row-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('rechnungenSelectedCount').textContent = count;
            document.getElementById('rechnungenSelectionGroup').classList.toggle('anzeigenfeld--hidden', count === 0);
        }

        // ========== DRK-SPEZIFISCHE DROPDOWN-AKTIONEN ==========
        // Überschreibt handleDropdownAction für DRK-spezifische Aktionen
        const originalHandleDropdownAction = window.handleDropdownAction;
        window.handleDropdownAction = function(action, dropdownMenu) {
            const type = dropdownMenu.dataset.type;
            const id = dropdownMenu.dataset.id;
            closeAllDropdowns();

            // DRK-spezifische Aktionen
            if (action === 'createInvoice') {
                openCreateInvoiceModal(id);
                return;
            }
            if (action === 'showInvoices') {
                showInvoicesForRecord(id);
                return;
            }

            // Standard-Aktionen an original weiterleiten
            if (originalHandleDropdownAction) {
                originalHandleDropdownAction(action, dropdownMenu);
            }
        };

        // Abrechnung erstellen für Record
        function openCreateInvoiceModal(recordId) {
            console.log('Abrechnung erstellen für Record:', recordId);
            // TODO: Modal öffnen mit vorausgewähltem Record
            alert('Abrechnung erstellen für Record: ' + recordId + '\n(Modal wird in Phase 8 implementiert)');
        }

        // Rechnungen für Record anzeigen (wechselt zu Tab Rechnungen mit Filter)
        function showInvoicesForRecord(recordId) {
            console.log('Rechnungen anzeigen für Record:', recordId);
            // Zum Rechnungen-Tab wechseln
            document.querySelector('[data-tab="rechnungen"]').click();
            // TODO: Filter auf diesen Record setzen
            alert('Rechnungen für Record: ' + recordId + '\n(Filter wird in Phase 6 implementiert)');
        }

        // Placeholder-Funktionen für Rechnungen
        function openRechnungDetails(id) { console.log('Details:', id); alert('Details für ' + id); }
        function downloadRechnungPdf(id) { console.log('PDF:', id); alert('PDF Download für ' + id); }
        function sendRechnungEmail(id) { console.log('Email:', id); alert('E-Mail senden für ' + id); }
        function erfasseZahlung(id) { console.log('Zahlung:', id); alert('Zahlung erfassen für ' + id); }
        function storniereRechnung(id) { console.log('Storno:', id); alert('Stornieren: ' + id); }
        function sendMailRechnungen() { alert('Sammel-E-Mail'); }
        function downloadPdfZip() { alert('PDF ZIP Download'); }

        // ========== FÄLLIG TAB ==========
        function renderFaelligTable() {
            const thead = document.getElementById('faelligTableHead');
            const tbody = document.getElementById('faelligTableBody');
            if (!thead || !tbody) return;

            // Header
            thead.innerHTML = `<tr>
                <th class="checkbox-cell"><input type="checkbox" class="row-checkbox" onclick="toggleSelectAllFaellig(this)"></th>
                <th class="col-name text-left">Kunde</th>
                <th class="col-m text-left">Kampagne</th>
                <th class="col-s text-center">Typ</th>
                <th class="col-s text-left">Fällig seit</th>
                <th class="col-m text-right">Betrag (ca.)</th>
                <th class="col-spacer"></th>
            </tr>`;

            // Body
            tbody.innerHTML = testFaelligData.map(f => `<tr data-id="${f.id}">
                <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" onchange="updateFaelligSelection()"></td>
                <td class="col-name text-left">${f.kunde}</td>
                <td class="col-m text-left">${f.kampagne}</td>
                <td class="col-s text-center"><span class="badge badge--small badge--warning">${f.typ}</span></td>
                <td class="col-s text-left">${f.faelligSeit}</td>
                <td class="col-m text-right">${f.betragCa}</td>
                <td class="col-spacer"></td>
            </tr>`).join('');
        }

        function toggleSelectAllFaellig(checkbox) {
            const checkboxes = document.querySelectorAll('#faelligTableBody .row-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateFaelligSelection();
        }

        function updateFaelligSelection() {
            const checkboxes = document.querySelectorAll('#faelligTableBody .row-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('faelligSelectedCount').textContent = count;
            document.getElementById('faelligSelectionGroup').classList.toggle('anzeigenfeld--hidden', count === 0);
        }

        function createAbrechnungFromFaellig() {
            const selected = document.querySelectorAll('#faelligTableBody .row-checkbox:checked');
            if (selected.length === 0) {
                alert('Bitte mindestens einen Eintrag auswählen');
                return;
            }
            // Modal öffnen mit vorausgewählten Daten
            openAbrechnungModal();
        }

        // ========== ABRECHNUNG MODAL ==========
        let abrechnungCurrentStep = 1;
        let abrechnungData = {};

        // Dynamisch geladene Kunden und Kampagnen
        let kundenData = [];
        let kampagnenData = {};
        let vertraegeData = {};

        // Kunden aus Supabase laden
        async function loadKundenFromDB() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/customers?select=id,name,full_name,kd_id,empfaenger_typ,rechnungsart&order=name`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                if (!response.ok) throw new Error('Fehler beim Laden der Kunden');
                const kunden = await response.json();
                kundenData = kunden.map(k => ({
                    id: k.id,
                    name: k.full_name || k.name,
                    kundenId: k.kd_id || '-',
                    empfaengerTyp: k.empfaenger_typ || '',
                    rechnungsart: k.rechnungsart || 'zusammen'
                }));
            } catch (err) {
                console.error('Fehler beim Laden der Kunden:', err);
                kundenData = [];
            }
        }

        // Kampagnen für einen Kunden laden
        async function loadKampagnenFromDB(customerId) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/campaigns?customer_id=eq.${customerId}&select=id,name,year,status&order=start_date.desc`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                if (!response.ok) throw new Error('Fehler beim Laden der Kampagnen');
                const kampagnen = await response.json();
                kampagnenData[customerId] = kampagnen.map(k => ({
                    id: k.id,
                    name: k.name + (k.year ? ` (${k.year})` : ''),
                    status: k.status
                }));
            } catch (err) {
                console.error('Fehler beim Laden der Kampagnen:', err);
                kampagnenData[customerId] = [];
            }
        }

        // Verträge (Rahmenverträge) für einen Kunden laden
        async function loadVertraegeFromDB(customerId) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/customer_contracts?customer_id=eq.${customerId}&contract_type=eq.rahmenvertrag&select=id,name,vertragsnummer&order=upload_date.desc`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                if (!response.ok) throw new Error('Fehler beim Laden der Verträge');
                const vertraege = await response.json();
                vertraegeData[customerId] = vertraege.map(v => ({
                    id: v.id,
                    name: v.name || 'Rahmenvertrag',
                    vertragsnummer: v.vertragsnummer || '-'
                }));
            } catch (err) {
                console.error('Fehler beim Laden der Verträge:', err);
                vertraegeData[customerId] = [];
            }
        }

        // Cache für geladene Einsatzgebiete (campaign_areas)
        let cachedCampaignAreas = {};
        // Cache für geladene Records
        let cachedRecords = [];

        async function openAbrechnungModal(recordId = null) {
            abrechnungCurrentStep = 1;
            abrechnungData = {};

            // Kunden laden aus Supabase
            const kundeSelect = document.getElementById('abrKunde');
            kundeSelect.innerHTML = '<option value="">Lade Kunden...</option>';

            await loadKundenFromDB();

            kundeSelect.innerHTML = '<option value="">Bitte auswählen...</option>' +
                kundenData.map(k => `<option value="${k.id}">${k.name} (${k.kundenId})</option>`).join('');

            // Reset andere Felder
            document.getElementById('abrKampagne').innerHTML = '<option value="">Erst Kunde wählen...</option>';
            document.getElementById('abrKampagne').disabled = true;
            document.getElementById('abrVertrag').innerHTML = '<option value="">Erst Kunde wählen...</option>';
            document.getElementById('abrVertrag').disabled = true;
            document.getElementById('abrEinsatzgebiete').innerHTML = '<div class="text-klein text-secondary">Erst Kampagne wählen...</div>';
            document.getElementById('abrKundeInfo').textContent = '';

            // Zeitraum vorbelegen (letzter Monat)
            const heute = new Date();
            const letzterMonatStart = new Date(heute.getFullYear(), heute.getMonth() - 1, 1);
            const letzterMonatEnde = new Date(heute.getFullYear(), heute.getMonth(), 0);
            document.getElementById('abrZeitraumVon').value = letzterMonatStart.toISOString().split('T')[0];
            document.getElementById('abrZeitraumBis').value = letzterMonatEnde.toISOString().split('T')[0];

            // UI zurücksetzen
            showAbrechnungStep(1);

            // Modal öffnen
            document.getElementById('abrechnungModal').classList.add('active');
        }

        function closeAbrechnungModal() {
            document.getElementById('abrechnungModal').classList.remove('active');
        }

        async function loadKampagnenForKunde() {
            const kundeId = document.getElementById('abrKunde').value;
            const kampagneSelect = document.getElementById('abrKampagne');
            const vertragSelect = document.getElementById('abrVertrag');

            if (!kundeId) {
                kampagneSelect.innerHTML = '<option value="">Erst Kunde wählen...</option>';
                kampagneSelect.disabled = true;
                vertragSelect.innerHTML = '<option value="">Erst Kunde wählen...</option>';
                vertragSelect.disabled = true;
                document.getElementById('abrKundeInfo').textContent = '';
                document.getElementById('abrEinsatzgebiete').innerHTML = '<div class="text-klein text-secondary">Erst Kampagne wählen...</div>';
                return;
            }

            // Kunde-Info anzeigen (inkl. Rechnungsart)
            const kunde = kundenData.find(k => k.id === kundeId);
            const rechnungsartLabel = kunde?.rechnungsart === 'getrennt' ? 'Getrennt' : 'Zusammen';
            document.getElementById('abrKundeInfo').textContent = kunde ? `${kunde.empfaengerTyp ? 'Typ: ' + kunde.empfaengerTyp + ' | ' : ''}Rechnung: ${rechnungsartLabel}` : '';

            // Rechnungsart für spätere Verwendung speichern
            abrechnungData.rechnungsart = kunde?.rechnungsart || 'zusammen';

            // Kampagnen und Verträge parallel laden
            kampagneSelect.innerHTML = '<option value="">Lade...</option>';
            vertragSelect.innerHTML = '<option value="">Lade...</option>';

            await Promise.all([
                loadKampagnenFromDB(kundeId),
                loadVertraegeFromDB(kundeId)
            ]);

            // Kampagnen anzeigen
            const kampagnen = kampagnenData[kundeId] || [];
            kampagneSelect.innerHTML = '<option value="">Bitte auswählen...</option>' +
                kampagnen.map(k => `<option value="${k.id}">${k.name}</option>`).join('');
            kampagneSelect.disabled = kampagnen.length === 0;

            // Verträge anzeigen
            const vertraege = vertraegeData[kundeId] || [];
            vertragSelect.innerHTML = '<option value="">Bitte auswählen...</option>' +
                vertraege.map(v => `<option value="${v.vertragsnummer}">${v.vertragsnummer} (${v.name})</option>`).join('');
            vertragSelect.disabled = vertraege.length === 0;

            document.getElementById('abrEinsatzgebiete').innerHTML = '<div class="text-klein text-secondary">Erst Kampagne wählen...</div>';
        }

        async function loadEinsatzgebiete() {
            const kampagneId = document.getElementById('abrKampagne').value;
            const container = document.getElementById('abrEinsatzgebiete');

            if (!kampagneId) {
                container.innerHTML = '<div class="text-klein text-secondary">Erst Kampagne wählen...</div>';
                return;
            }

            container.innerHTML = '<div class="text-klein text-secondary">Lade Einsatzgebiete...</div>';

            try {
                // Campaign_areas aus Supabase laden
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/campaign_areas?campaign_id=eq.${kampagneId}&select=id,name,provision_sondierung,provision_regular,einwohnerzahl,stornopuffer`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );

                if (!response.ok) throw new Error('Fehler beim Laden der Einsatzgebiete');

                const gebiete = await response.json();
                cachedCampaignAreas[kampagneId] = gebiete;

                if (gebiete.length === 0) {
                    container.innerHTML = '<div class="text-klein text-secondary">Keine Einsatzgebiete gefunden</div>';
                    return;
                }

                // Checkboxen rendern (MG/JE wird bei Vorschau aus Records berechnet)
                container.innerHTML = gebiete.map(g => `
                    <label class="checkbox-item">
                        <input type="checkbox" value="${g.id}"
                            data-name="${g.name}"
                            data-provision-sondierung='${JSON.stringify(g.provision_sondierung || {j1:80,j2:50,j3:30,j4:0,j5:0,limit:100,limitType:"mg"})}'
                            data-provision-regular='${JSON.stringify(g.provision_regular || {j1:60,j2:40,j3:20,j4:0,j5:0})}'
                            data-einwohnerzahl="${g.einwohnerzahl || 0}"
                            data-stornopuffer="${g.stornopuffer || 10}"
                            checked>
                        <span class="checkbox-label">${g.name}</span>
                        <span class="checkbox-info text-klein" id="gebietInfo_${g.id}">Lade MG...</span>
                    </label>
                `).join('');

                // Event-Listener für Checkboxen
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', updateEinsatzgebieteInfo);
                });

                // MG/JE Info initial leer (wird bei Zeitraum-Änderung aktualisiert)
                updateEinsatzgebieteInfo();

            } catch (error) {
                console.error('Fehler:', error);
                container.innerHTML = '<div class="text-klein text-error">Fehler beim Laden der Einsatzgebiete</div>';
            }
        }

        function updateEinsatzgebieteInfo() {
            const checkboxes = document.querySelectorAll('#abrEinsatzgebiete input[type="checkbox"]:checked');
            document.getElementById('abrEinsatzgebieteInfo').textContent =
                `Ausgewählt: ${checkboxes.length} Gebiete (MG/JE wird bei Vorschau berechnet)`;
        }

        function updateStornopufferVisibility() {
            const typ = document.getElementById('abrTyp').value;
            // Stornopuffer nur bei ZA
            const showStornopuffer = (typ === 'ZA');
            // Kann später für UI-Anpassungen genutzt werden
        }

        function showAbrechnungStep(step) {
            abrechnungCurrentStep = step;

            // Tabs aktualisieren
            document.getElementById('tabAuswahl').classList.toggle('active', step === 1);
            document.getElementById('tabVorschau').classList.toggle('active', step === 2);

            // Inhalt anzeigen
            document.getElementById('abrechnungStep1').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('abrechnungStep2').style.display = step === 2 ? 'block' : 'none';

            // Buttons aktualisieren
            document.getElementById('abrBtnZurueck').style.display = step === 2 ? 'inline-flex' : 'none';
            document.getElementById('abrBtnWeiter').style.display = step === 1 ? 'inline-flex' : 'none';
            document.getElementById('abrBtnEntwurf').style.display = step === 2 ? 'inline-flex' : 'none';
            document.getElementById('abrBtnErstellen').style.display = step === 2 ? 'inline-flex' : 'none';

            // Subtitle aktualisieren
            document.getElementById('abrechnungModalSubtitle').textContent =
                step === 1 ? 'Schritt 1: Auswahl' : 'Schritt 2: Vorschau';
        }

        async function abrechnungWeiter() {
            // Validierung
            if (!document.getElementById('abrKunde').value) {
                alert('Bitte Kunde auswählen');
                return;
            }
            if (!document.getElementById('abrKampagne').value) {
                alert('Bitte Kampagne auswählen');
                return;
            }

            const selectedGebiete = document.querySelectorAll('#abrEinsatzgebiete input[type="checkbox"]:checked');
            if (selectedGebiete.length === 0) {
                alert('Bitte mindestens ein Einsatzgebiet auswählen');
                return;
            }

            const zeitraumVon = document.getElementById('abrZeitraumVon').value;
            const zeitraumBis = document.getElementById('abrZeitraumBis').value;

            if (!zeitraumVon || !zeitraumBis) {
                alert('Bitte Zeitraum auswählen');
                return;
            }

            // Gebiete-IDs für Query sammeln
            const gebietIds = Array.from(selectedGebiete).map(cb => cb.value);

            // Button deaktivieren während Laden
            const weiterBtn = document.getElementById('abrBtnWeiter');
            weiterBtn.disabled = true;
            weiterBtn.textContent = 'Lade Records...';

            try {
                // Records für Zeitraum und Gebiete laden
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/records?campaign_area_id=in.(${gebietIds.join(',')})&start_date=gte.${zeitraumVon}&start_date=lte.${zeitraumBis}&status=eq.aktiv&select=id,campaign_area_id,yearly_amount,last_name,first_name,start_date`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );

                if (!response.ok) throw new Error('Fehler beim Laden der Records');

                cachedRecords = await response.json();

                // Daten sammeln inkl. provision_sondierung etc.
                abrechnungData = {
                    kundeId: document.getElementById('abrKunde').value,
                    kundeName: document.getElementById('abrKunde').options[document.getElementById('abrKunde').selectedIndex].text,
                    kampagneId: document.getElementById('abrKampagne').value,
                    kampagneName: document.getElementById('abrKampagne').options[document.getElementById('abrKampagne').selectedIndex].text,
                    typ: document.getElementById('abrTyp').value,
                    vertrag: document.getElementById('abrVertrag').value,
                    zeitraumVon: zeitraumVon,
                    zeitraumBis: zeitraumBis,
                    einsatzgebiete: Array.from(selectedGebiete).map(cb => ({
                        id: cb.value,
                        name: cb.dataset.name,
                        provisionSondierung: JSON.parse(cb.dataset.provisionSondierung),
                        provisionRegular: JSON.parse(cb.dataset.provisionRegular),
                        einwohnerzahl: parseInt(cb.dataset.einwohnerzahl) || 0,
                        stornopuffer: parseInt(cb.dataset.stornopuffer) || 10
                    })),
                    records: cachedRecords
                };

                // Vorschau generieren
                generateVorschau();

                // Schritt 2 anzeigen
                showAbrechnungStep(2);

            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Laden der Records: ' + error.message);
            } finally {
                weiterBtn.disabled = false;
                weiterBtn.textContent = 'Weiter';
            }
        }

        function abrechnungZurueck() {
            showAbrechnungStep(1);
        }

        function generateVorschau() {
            const typ = abrechnungData.typ;
            const gebiete = abrechnungData.einsatzgebiete;
            const records = abrechnungData.records || [];
            const rechnungsart = abrechnungData.rechnungsart || 'zusammen';

            // Bei "getrennt": Separate Rechnungen pro Einsatzgebiet
            if (rechnungsart === 'getrennt' && gebiete.length > 1) {
                generateVorschauGetrennt();
                return;
            }

            // Vergütungsjahr bestimmen (j1 für ZA/EA, j2 für 1JA, etc.)
            const vjKey = typ === 'ZA' || typ === 'EA' ? 'j1' :
                          typ === '1JA' ? 'j2' :
                          typ === '2JA' ? 'j3' :
                          typ === '3JA' ? 'j4' : 'j5';

            // Sondierung/Regular Listen pro Gebiet erstellen
            const sondierungPositionen = [];
            const regularPositionen = [];

            gebiete.forEach(gebiet => {
                // Records für dieses Gebiet filtern
                let gebietRecords = records.filter(r => r.campaign_area_id === gebiet.id);

                // Nach yearly_amount ASC sortieren (kleinste zuerst → Sondierung)
                gebietRecords.sort((a, b) => (a.yearly_amount || 0) - (b.yearly_amount || 0));

                // Sondierungslimit berechnen
                const limitConfig = gebiet.provisionSondierung || { limit: 100, limitType: 'mg' };
                let sondierungLimit = limitConfig.limit || 100;

                if (limitConfig.limitType === 'prozent' && gebiet.einwohnerzahl > 0) {
                    // Prozent der Einwohnerzahl
                    sondierungLimit = Math.floor(gebiet.einwohnerzahl * (limitConfig.limit / 100));
                }

                // Aufteilung: erste X → Sondierung, Rest → Regular
                const sondierungRecords = gebietRecords.slice(0, sondierungLimit);
                const regularRecords = gebietRecords.slice(sondierungLimit);

                // Nach Familienname sortieren
                sondierungRecords.sort((a, b) => (a.last_name || '').localeCompare(b.last_name || ''));
                regularRecords.sort((a, b) => (a.last_name || '').localeCompare(b.last_name || ''));

                // Provisionsätze aus campaign_area
                const satzSondierung = gebiet.provisionSondierung?.[vjKey] || 0;
                const satzRegular = gebiet.provisionRegular?.[vjKey] || 0;

                // Aggregierte Position für Sondierung
                if (sondierungRecords.length > 0) {
                    const sondJe = sondierungRecords.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
                    sondierungPositionen.push({
                        gebietId: gebiet.id,
                        gebietName: gebiet.name,
                        mg: sondierungRecords.length,
                        je: sondJe,
                        satz: satzSondierung,
                        betrag: sondJe * satzSondierung / 100,
                        records: sondierungRecords
                    });
                }

                // Aggregierte Position für Regular
                if (regularRecords.length > 0) {
                    const regJe = regularRecords.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
                    regularPositionen.push({
                        gebietId: gebiet.id,
                        gebietName: gebiet.name,
                        mg: regularRecords.length,
                        je: regJe,
                        satz: satzRegular,
                        betrag: regJe * satzRegular / 100,
                        records: regularRecords
                    });
                }
            });

            // Stornopuffer (nur bei ZA)
            const stornopufferProzent = typ === 'ZA' ? (gebiete[0]?.stornopuffer || 10) : 0;

            // Gesamtsummen
            const totalMg = records.length;
            const totalJe = records.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
            const sondMg = sondierungPositionen.reduce((sum, p) => sum + p.mg, 0);
            const regMg = regularPositionen.reduce((sum, p) => sum + p.mg, 0);

            // Summary rendern
            document.getElementById('vorschauSummary').innerHTML = `
                <div class="vorschau-header">
                    <div class="vorschau-info">
                        <span class="text-normal--fett">${abrechnungData.kundeName}</span>
                        <span class="text-klein">${abrechnungData.kampagneName} | ${abrechnungData.vertrag}</span>
                    </div>
                    <div class="vorschau-badge">
                        <span class="badge badge--small badge--warning">${typ}</span>
                    </div>
                </div>
                <div class="vorschau-stats">
                    <div class="vorschau-stat">
                        <span class="text-klein">Zeitraum</span>
                        <span class="text-normal--fett">${formatDate(abrechnungData.zeitraumVon)} - ${formatDate(abrechnungData.zeitraumBis)}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Einsatzgebiete</span>
                        <span class="text-normal--fett">${gebiete.length}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Gesamt MG</span>
                        <span class="text-normal--fett">${totalMg} (${sondMg} Sond. / ${regMg} Reg.)</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Gesamt JE</span>
                        <span class="text-normal--fett">${totalJe.toLocaleString('de-DE')} €</span>
                    </div>
                </div>
            `;

            // Tabelle generieren
            let rows = [];
            let posNr = 1;
            let zwischensumme = 0;

            // Sondierung
            if (sondierungPositionen.length > 0) {
                const sondSatz = sondierungPositionen[0]?.satz || 0;
                rows.push(`<tr class="table-section-header"><td colspan="6" class="text-normal--fett">Sonderkonditionen (${sondSatz}%)</td></tr>`);
                sondierungPositionen.forEach(pos => {
                    zwischensumme += pos.betrag;
                    rows.push(`<tr>
                        <td>A${posNr++}</td>
                        <td>${pos.gebietName}</td>
                        <td class="text-right">${pos.mg}</td>
                        <td class="text-right">${pos.je.toLocaleString('de-DE')}</td>
                        <td class="text-center">${pos.satz}</td>
                        <td class="text-right">${pos.betrag.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                    </tr>`);
                });
            }

            // Regular
            if (regularPositionen.length > 0) {
                const regSatz = regularPositionen[0]?.satz || 0;
                rows.push(`<tr class="table-section-header"><td colspan="6" class="text-normal--fett">Regularkonditionen (${regSatz}%)</td></tr>`);
                regularPositionen.forEach(pos => {
                    zwischensumme += pos.betrag;
                    rows.push(`<tr>
                        <td>B${posNr++}</td>
                        <td>${pos.gebietName}</td>
                        <td class="text-right">${pos.mg}</td>
                        <td class="text-right">${pos.je.toLocaleString('de-DE')}</td>
                        <td class="text-center">${pos.satz}</td>
                        <td class="text-right">${pos.betrag.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                    </tr>`);
                });
            }

            // Falls keine Records
            if (rows.length === 0) {
                rows.push(`<tr><td colspan="6" class="text-center text-secondary">Keine Datensätze im gewählten Zeitraum</td></tr>`);
            }

            document.getElementById('vorschauTableBody').innerHTML = rows.join('');

            // Footer mit Summen
            const stornopuffer = zwischensumme * stornopufferProzent / 100;
            const netto = zwischensumme - stornopuffer;
            const ust = netto * 0.19;
            const brutto = netto + ust;

            let footerRows = [`<tr class="table-sum-row">
                <td colspan="5" class="text-right text-normal--fett">Zwischensumme</td>
                <td class="text-right text-normal--fett">${zwischensumme.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
            </tr>`];

            if (stornopufferProzent > 0) {
                footerRows.push(`<tr>
                    <td colspan="5" class="text-right">Stornopuffer (${stornopufferProzent}%)</td>
                    <td class="text-right text-error">-${stornopuffer.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
                </tr>`);
            }

            footerRows.push(`<tr>
                <td colspan="5" class="text-right text-normal--fett">Netto</td>
                <td class="text-right text-normal--fett">${netto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
            </tr>`);
            footerRows.push(`<tr>
                <td colspan="5" class="text-right">USt (19%)</td>
                <td class="text-right">${ust.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
            </tr>`);
            footerRows.push(`<tr class="table-total-row">
                <td colspan="5" class="text-right text-normal--fett">Brutto</td>
                <td class="text-right text-normal--fett">${brutto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
            </tr>`);

            document.getElementById('vorschauTableFoot').innerHTML = footerRows.join('');

            // Daten für Speichern merken
            abrechnungData.sondierungPositionen = sondierungPositionen;
            abrechnungData.regularPositionen = regularPositionen;
            abrechnungData.zwischensumme = zwischensumme;
            abrechnungData.stornopuffer = stornopuffer;
            abrechnungData.stornopufferProzent = stornopufferProzent;
            abrechnungData.netto = netto;
            abrechnungData.ust = ust;
            abrechnungData.brutto = brutto;
        }

        // Vorschau für getrennte Rechnungen (eine pro Einsatzgebiet)
        function generateVorschauGetrennt() {
            const typ = abrechnungData.typ;
            const gebiete = abrechnungData.einsatzgebiete;
            const records = abrechnungData.records || [];

            const vjKey = typ === 'ZA' || typ === 'EA' ? 'j1' :
                          typ === '1JA' ? 'j2' :
                          typ === '2JA' ? 'j3' :
                          typ === '3JA' ? 'j4' : 'j5';

            // Rechnungen pro Gebiet berechnen
            const rechnungen = [];
            let gesamtBrutto = 0;

            gebiete.forEach(gebiet => {
                const gebietRecords = records.filter(r => r.campaign_area_id === gebiet.id);
                if (gebietRecords.length === 0) return;

                gebietRecords.sort((a, b) => (a.yearly_amount || 0) - (b.yearly_amount || 0));

                const limitConfig = gebiet.provisionSondierung || { limit: 100, limitType: 'mg' };
                let sondierungLimit = limitConfig.limit || 100;
                if (limitConfig.limitType === 'prozent' && gebiet.einwohnerzahl > 0) {
                    sondierungLimit = Math.floor(gebiet.einwohnerzahl * (limitConfig.limit / 100));
                }

                const sondierungRecords = gebietRecords.slice(0, sondierungLimit);
                const regularRecords = gebietRecords.slice(sondierungLimit);

                const satzSondierung = gebiet.provisionSondierung?.[vjKey] || 0;
                const satzRegular = gebiet.provisionRegular?.[vjKey] || 0;
                const stornopufferProzent = typ === 'ZA' ? (gebiet.stornopuffer || 10) : 0;

                const sondJe = sondierungRecords.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
                const regJe = regularRecords.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
                const sondBetrag = sondJe * satzSondierung / 100;
                const regBetrag = regJe * satzRegular / 100;
                const zwischensumme = sondBetrag + regBetrag;
                const stornopuffer = zwischensumme * stornopufferProzent / 100;
                const netto = zwischensumme - stornopuffer;
                const ust = netto * 0.19;
                const brutto = netto + ust;

                gesamtBrutto += brutto;

                rechnungen.push({
                    gebiet: gebiet,
                    mgSond: sondierungRecords.length,
                    mgReg: regularRecords.length,
                    mgTotal: gebietRecords.length,
                    sondBetrag,
                    regBetrag,
                    zwischensumme,
                    stornopuffer,
                    stornopufferProzent,
                    netto,
                    ust,
                    brutto,
                    records: gebietRecords
                });
            });

            // Summary mit Hinweis auf getrennte Rechnungen
            document.getElementById('vorschauSummary').innerHTML = `
                <div class="vorschau-header">
                    <div class="vorschau-info">
                        <span class="text-normal--fett">${abrechnungData.kundeName}</span>
                        <span class="text-klein">${abrechnungData.kampagneName} | ${abrechnungData.vertrag}</span>
                    </div>
                    <div class="vorschau-badge">
                        <span class="badge badge--small badge--warning">${typ}</span>
                        <span class="badge badge--small badge--info">Getrennt: ${rechnungen.length} Rechnungen</span>
                    </div>
                </div>
                <div class="vorschau-stats">
                    <div class="vorschau-stat">
                        <span class="text-klein">Zeitraum</span>
                        <span class="text-normal--fett">${formatDate(abrechnungData.zeitraumVon)} - ${formatDate(abrechnungData.zeitraumBis)}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Rechnungen</span>
                        <span class="text-normal--fett">${rechnungen.length}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Gesamt MG</span>
                        <span class="text-normal--fett">${records.length}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Gesamt Brutto</span>
                        <span class="text-normal--fett">${gesamtBrutto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</span>
                    </div>
                </div>
            `;

            // Tabelle: Liste der einzelnen Rechnungen
            let rows = [];
            rows.push(`<tr class="table-section-header"><td colspan="6" class="text-normal--fett">Einzelne Rechnungen</td></tr>`);

            rechnungen.forEach((r, idx) => {
                rows.push(`<tr>
                    <td>${idx + 1}</td>
                    <td>${r.gebiet.name}</td>
                    <td class="text-right">${r.mgTotal} (${r.mgSond}/${r.mgReg})</td>
                    <td class="text-right">${r.zwischensumme.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                    <td class="text-right">${r.stornopufferProzent > 0 ? '-' + r.stornopuffer.toLocaleString('de-DE', {minimumFractionDigits: 2}) : '-'}</td>
                    <td class="text-right text-normal--fett">${r.brutto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
                </tr>`);
            });

            if (rechnungen.length === 0) {
                rows.push(`<tr><td colspan="6" class="text-center text-secondary">Keine Datensätze im gewählten Zeitraum</td></tr>`);
            }

            document.getElementById('vorschauTableBody').innerHTML = rows.join('');

            // Footer mit Gesamtsumme
            document.getElementById('vorschauTableFoot').innerHTML = `
                <tr class="table-total-row">
                    <td colspan="5" class="text-right text-normal--fett">Gesamt (${rechnungen.length} Rechnungen)</td>
                    <td class="text-right text-normal--fett">${gesamtBrutto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
                </tr>
            `;

            // Daten für Speichern
            abrechnungData.rechnungen = rechnungen;
            abrechnungData.gesamtBrutto = gesamtBrutto;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('de-DE');
        }

        function saveAbrechnungEntwurf() {
            console.log('Speichere als Entwurf:', abrechnungData);
            alert('Abrechnung als Entwurf gespeichert\n(RPC-Funktion wird in Phase 11 implementiert)');
            closeAbrechnungModal();
            // TODO: RPC aufrufen mit status = 'entwurf'
        }

        function saveAbrechnungErstellen() {
            console.log('Erstelle Abrechnung:', abrechnungData);
            alert('Abrechnung erstellt\n(RPC-Funktion wird in Phase 11 implementiert)');
            closeAbrechnungModal();
            // TODO: RPC aufrufen mit status = 'offen', Rechnungsnummer generieren
        }

        // Update: openCreateInvoiceModal verweist auf das neue Modal
        function openCreateInvoiceModal(recordId) {
            openAbrechnungModal(recordId);
        }
    </script>
</body>
</html>
