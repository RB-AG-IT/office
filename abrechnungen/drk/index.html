<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datensätze - RB Inside Office</title>
    <!-- Zentrale Styles -->
    <link rel="stylesheet" href="../../css/styles.css">
    <script src="../../js/main.js"></script>
    <!-- Zentrale Scripts -->
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- SheetJS für Excel/CSV Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF für PDF-Generierung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <!-- html2pdf für HTML zu PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Seiten-spezifische Styles (nur wenn nötig) */
        body {
            background: var(--bg-secondary);
        }
        /* Dropdown-Optionen Stornieren und Löschen ausblenden */
        .dropdown-item.warning,
        .dropdown-item.danger,
        .dropdown-item.warning + .dropdown-divider,
        .dropdown-divider:has(+ .dropdown-item.warning) {
            display: none;
        }

        /* Abrechnung Modal Styles */
        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-primary);
            border-radius: var(--radius-xs);
            cursor: pointer;
        }
        .checkbox-item:hover {
            background: var(--bg-hover);
        }
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-color);
        }
        .checkbox-label {
            flex: 1;
            font-size: var(--text-normal);
        }
        .checkbox-info {
            color: var(--text-secondary);
        }

        /* Vorschau Styles */
        .vorschau-summary {
            margin-bottom: var(--spacing-md);
        }
        .vorschau-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        .vorschau-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .vorschau-stats {
            display: flex;
            gap: var(--spacing-lg);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }
        .vorschau-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .vorschau-table-container {
            overflow-x: auto;
        }
        .table-section-header td {
            background: var(--bg-secondary);
            padding-top: var(--spacing-md) !important;
        }
        .table-sum-row td {
            border-top: 1px solid var(--border-color);
            padding-top: var(--spacing-sm) !important;
        }
        .table-total-row td {
            background: var(--bg-secondary);
            font-size: var(--text-normal);
        }
        .text-error {
            color: var(--error);
        }
    </style>
</head>
<body class="datensaetze-page">
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-row">
            <div class="page-header-links">
                <span class="text-ueberschrift-unterabschnitt">DRK</span>
            </div>
            <div class="page-header-mitte">
                <span class="text-ueberschrift">Abrechnungen</span>
            </div>
        </div>
        <!-- Lokale Tabs (per Klick navigierbar) -->
        <div class="page-header-tabs" id="datensaetzeSubTabs">
            <div class="kw-tab active" data-tab="records">Kunden <span class="tab-badge" id="recordsBadge">0</span></div>
            <div class="kw-tab" data-tab="rechnungen">Rechnungen <span class="tab-badge" id="rechnungenBadge">0</span></div>
            <div class="kw-tab" data-tab="faellig">Fällig <span class="tab-badge" id="faelligBadge">0</span></div>
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-content page-content--table">

            <!-- NEUMITGLIEDER / ERHÖHUNGEN TAB -->
            <div class="kw-tab-content active" id="tab-records">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Anzeigenfeld 1: Filter -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--min-height"></div>
                        <!-- Anzeigenfeld 2: Auswahl-Aktionen (erscheint bei Selektion) -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden" id="recordsSelectionGroup">
                            <span class="btn btn-sm" id="recordsSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="recordsSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMail('records')">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="createAbrechnung('records')">
                                <span class="icon icon--dokument"></span>
                                Abrechnung erstellen
                            </button>
                        </div>
                        <!-- Spacer -->
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Anzeigenfeld 3: Spalten & Audit (rechts) -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('records')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                            <button class="btn btn-sm" onclick="openAuditModal('nmg-erh', 'default')">
                                <span class="icon icon--uhr"></span>
                                Audit
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="recordsTable">
                            <thead id="recordsTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                            <tfoot id="recordsTableFoot">
                                <!-- Wird dynamisch gerendert -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RECHNUNGEN TAB -->
            <div class="kw-tab-content" id="tab-rechnungen">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Filter -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--min-height">
                            <select class="btn btn-sm" id="filterRechnungStatus" onchange="filterRechnungen()">
                                <option value="all">Alle Status</option>
                                <option value="entwurf">Entwurf</option>
                                <option value="offen">Offen</option>
                                <option value="geplant">Geplant</option>
                                <option value="bezahlt">Bezahlt</option>
                                <option value="storniert">Storniert</option>
                            </select>
                            <select class="btn btn-sm" id="filterRechnungTyp" onchange="filterRechnungen()">
                                <option value="all">Alle Typen</option>
                                <option value="ZA">Zwischenabrechnung</option>
                                <option value="EA">Endabrechnung</option>
                                <option value="1JA">1. Jahresabrechnung</option>
                                <option value="2JA">2. Jahresabrechnung</option>
                                <option value="3JA">3. Jahresabrechnung</option>
                                <option value="4JA">4. Jahresabrechnung</option>
                            </select>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--divider"></div>
                        <!-- Auswahl-Aktionen -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden" id="rechnungenSelectionGroup">
                            <span class="btn btn-sm" id="rechnungenSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="rechnungenSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMailRechnungen()">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="downloadPdfZip()">
                                <span class="icon icon--dokument"></span>
                                PDF (ZIP)
                            </button>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Rechts -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('rechnungen')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="rechnungenTable">
                            <thead id="rechnungenTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="rechnungenTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FÄLLIG TAB -->
            <div class="kw-tab-content" id="tab-faellig">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Platzhalter für min-height -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--min-height"></div>
                        <!-- Auswahl-Aktionen -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden" id="faelligSelectionGroup">
                            <span class="btn btn-sm" id="faelligSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="faelligSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm btn-primary" onclick="createAbrechnungFromFaellig()">
                                <span class="icon icon--dokument"></span>
                                Abrechnung erstellen
                            </button>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="faelligTable">
                            <thead id="faelligTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="faelligTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
    </div><!-- Ende page-content -->
</div><!-- Ende page-container -->

<!-- Storno Modal (aus zentralem Template) -->
    <!-- Wird durch ModalTemplates.init(['storno']) erstellt -->

    <!-- Alle Modals werden durch ModalTemplates.init() erstellt -->
    <!-- Verfügbar: storno, columns, edit, import, export -->

<!-- Abrechnung erstellen Modal -->
<div class="modal modal-l" id="abrechnungModal">
    <div class="page-container page-container--modal">
        <!-- Modal Header -->
        <div class="page-header">
            <div class="page-header-row">
                <div class="page-header-links">
                    <span class="text-ueberschrift">Abrechnung erstellen</span>
                    <span class="text-klein" id="abrechnungModalSubtitle">Schritt 1: Auswahl</span>
                </div>
                <div class="page-header-mitte"></div>
                <div class="page-header-rechts">
                    <button class="btn btn-icon" onclick="closeAbrechnungModal()">
                        <span class="icon icon--schliessen"></span>
                    </button>
                </div>
            </div>
            <div class="page-header-tabs">
                <div class="kw-tab active" data-tab="auswahl" id="tabAuswahl">1. Auswahl</div>
                <div class="kw-tab" data-tab="vorschau" id="tabVorschau">2. Vorschau</div>
            </div>
        </div>

        <!-- Schritt 1: Auswahl -->
        <div class="page-content page-content--modal" id="abrechnungStep1">
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Kunde</label>
                    <select class="eingabefeld" id="abrKunde" onchange="loadKampagnenForKunde()">
                        <option value="">Bitte auswählen...</option>
                    </select>
                    <span class="eingabefeld-beschriftung-unten" id="abrKundeInfo"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Kampagne</label>
                    <select class="eingabefeld" id="abrKampagne" onchange="loadEinsatzgebiete()" disabled>
                        <option value="">Erst Kunde wählen...</option>
                    </select>
                    <span class="eingabefeld-beschriftung-unten" id="abrKampagneInfo"></span>
                </div>
            </div>
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Abrechnungstyp</label>
                    <select class="eingabefeld" id="abrTyp" onchange="updateStornopufferVisibility()">
                        <option value="ZA" selected>Zwischenabrechnung (ZA)</option>
                        <option value="EA">Endabrechnung (EA)</option>
                        <option value="1JA">1. Jahresabrechnung (VJ2)</option>
                        <option value="2JA">2. Jahresabrechnung (VJ3)</option>
                        <option value="3JA">3. Jahresabrechnung (VJ4)</option>
                        <option value="4JA">4. Jahresabrechnung (VJ5)</option>
                    </select>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Vertragsnummer</label>
                    <select class="eingabefeld" id="abrVertrag" disabled>
                        <option value="">Erst Kunde wählen...</option>
                    </select>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Zeitraum von</label>
                    <input type="date" class="eingabefeld" id="abrZeitraumVon" onclick="openAbrZeitraumCalendar(event)">
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Zeitraum bis</label>
                    <input type="date" class="eingabefeld" id="abrZeitraumBis" onclick="openAbrZeitraumCalendar(event)">
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Einsatzgebiete</label>
                    <div class="checkbox-list" id="abrEinsatzgebiete">
                        <div class="text-klein text-secondary">Erst Kampagne wählen...</div>
                    </div>
                    <span class="eingabefeld-beschriftung-unten" id="abrEinsatzgebieteInfo"></span>
                </div>
            </div>
        </div>

        <!-- Schritt 2: Vorschau -->
        <div class="page-content page-content--modal" id="abrechnungStep2" style="display: none;">
            <div class="vorschau-summary" id="vorschauSummary">
                <!-- Wird dynamisch gefüllt -->
            </div>
            <div class="vorschau-table-container">
                <table class="table table--compact" id="vorschauTable">
                    <thead>
                        <tr>
                            <th class="text-left">Position</th>
                            <th class="text-left">Beschreibung</th>
                            <th class="text-right">MG</th>
                            <th class="text-right">JE (€)</th>
                            <th class="text-center">%</th>
                            <th class="text-right">Betrag (€)</th>
                        </tr>
                    </thead>
                    <tbody id="vorschauTableBody">
                        <!-- Wird dynamisch gefüllt -->
                    </tbody>
                    <tfoot id="vorschauTableFoot">
                        <!-- Wird dynamisch gefüllt -->
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="page-footer">
            <button class="btn btn-secondary" id="abrBtnZurueck" onclick="abrechnungZurueck()" style="display: none;">Zurück</button>
            <div class="anzeigenfeld--spacer"></div>
            <button class="btn btn-secondary" onclick="closeAbrechnungModal()">Abbrechen</button>
            <button class="btn btn-primary" id="abrBtnWeiter" onclick="abrechnungWeiter()">Weiter</button>
            <button class="btn btn-secondary" id="abrBtnEntwurf" onclick="saveAbrechnungEntwurf()" style="display: none;">Als Entwurf</button>
            <button class="btn btn-primary" id="abrBtnErstellen" onclick="saveAbrechnungErstellen()" style="display: none;">Erstellen</button>
        </div>
    </div>
    </div>
</div>

<!-- Modal: Rechnung Details -->
<div class="modal modal-l" id="rechnungDetailModal">
    <div class="modal-header">
        <h2>Rechnung Details</h2>
        <button class="modal-close" onclick="closeRechnungDetailModal()">&times;</button>
    </div>
    <div class="modal-body">
        <!-- Kopfbereich -->
        <div class="detail-header" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
            <div>
                <div class="text-klein text-grau">Rechnungsnummer</div>
                <div class="text-normal--fett" id="detailRechnungsnummer">-</div>
            </div>
            <div>
                <div class="text-klein text-grau">Status</div>
                <select id="detailStatus" class="input-field" style="width: auto; min-width: 150px;" onchange="updateRechnungStatus()">
                    <option value="entwurf">Entwurf</option>
                    <option value="offen">Offen</option>
                    <option value="geplant">Geplant</option>
                    <option value="bezahlt">Bezahlt</option>
                    <option value="storniert">Storniert</option>
                </select>
            </div>
            <div>
                <div class="text-klein text-grau">Kunde</div>
                <div class="text-normal" id="detailKunde">-</div>
            </div>
            <div>
                <div class="text-klein text-grau">Kampagne</div>
                <div class="text-normal" id="detailKampagne">-</div>
            </div>
            <div>
                <div class="text-klein text-grau">Abrechnungstyp</div>
                <div class="text-normal" id="detailTyp">-</div>
            </div>
            <div>
                <div class="text-klein text-grau">Zeitraum</div>
                <div class="text-normal" id="detailZeitraum">-</div>
            </div>
            <div>
                <div class="text-klein text-grau">Vertragsnummer</div>
                <div class="text-normal" id="detailVertrag">-</div>
            </div>
            <div>
                <div class="text-klein text-grau">Erstellt am</div>
                <div class="text-normal" id="detailErstellt">-</div>
            </div>
        </div>

        <!-- Positionen -->
        <div class="detail-section" style="margin-bottom: 1.5rem;">
            <h3 class="text-normal--fett" style="margin-bottom: 0.5rem;">Positionen</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Beschreibung</th>
                        <th class="text-right">MG</th>
                        <th class="text-right">JE</th>
                        <th class="text-right">Satz</th>
                        <th class="text-right">Betrag</th>
                    </tr>
                </thead>
                <tbody id="detailPositionen">
                    <tr><td colspan="5" class="text-grau">Keine Positionen</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Summen -->
        <div class="detail-summen" style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; max-width: 300px; margin-left: auto; margin-bottom: 1.5rem;">
            <span class="text-normal">Zwischensumme:</span>
            <span class="text-normal text-right" id="detailZwischensumme">0,00 €</span>
            <span class="text-normal" id="detailStornopufferLabel" style="display: none;">Stornopuffer:</span>
            <span class="text-normal text-right" id="detailStornopuffer" style="display: none;">0,00 €</span>
            <span class="text-normal">Netto:</span>
            <span class="text-normal text-right" id="detailNetto">0,00 €</span>
            <span class="text-normal">USt (19%):</span>
            <span class="text-normal text-right" id="detailUst">0,00 €</span>
            <span class="text-normal--fett">Brutto:</span>
            <span class="text-normal--fett text-right" id="detailBrutto">0,00 €</span>
        </div>

        <!-- Zahlungen -->
        <div class="detail-section" style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h3 class="text-normal--fett">Zahlungen</h3>
                <button class="btn btn-small btn-secondary" onclick="openZahlungModal()">+ Zahlung erfassen</button>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th class="text-right">Betrag</th>
                        <th>Notiz</th>
                    </tr>
                </thead>
                <tbody id="detailZahlungen">
                    <tr><td colspan="3" class="text-grau">Keine Zahlungen</td></tr>
                </tbody>
            </table>
            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                <span class="text-normal">Offen:</span>
                <span class="text-normal--fett" id="detailOffen">0,00 €</span>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="downloadRechnungPdfModal()">PDF</button>
            <button class="btn btn-secondary" onclick="sendRechnungEmailModal()">E-Mail</button>
            <button class="btn btn-danger" onclick="storniereRechnungModal()">Stornieren</button>
        </div>
        <button class="btn btn-primary" onclick="closeRechnungDetailModal()">Schließen</button>
    </div>
</div>

<!-- Modal: Zahlung erfassen -->
<div class="modal modal-s" id="zahlungModal">
    <div class="modal-header">
        <h2>Zahlung erfassen</h2>
        <button class="modal-close" onclick="closeZahlungModal()">&times;</button>
    </div>
    <div class="modal-body">
        <!-- Rechnungsinfo -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
            <div>
                <div class="text-klein text-grau">Rechnung</div>
                <div class="text-normal--fett" id="zahlungRechnungsnr">-</div>
            </div>
            <div>
                <div class="text-klein text-grau">Rechnungsbetrag</div>
                <div class="text-normal" id="zahlungRechnungsbetrag">0,00 €</div>
            </div>
            <div>
                <div class="text-klein text-grau">Bereits bezahlt</div>
                <div class="text-normal" id="zahlungBereitsBezahlt">0,00 €</div>
            </div>
            <div>
                <div class="text-klein text-grau">Offen</div>
                <div class="text-normal--fett" id="zahlungOffen">0,00 €</div>
            </div>
        </div>

        <!-- Eingabe -->
        <div class="form-group" style="margin-bottom: 1rem;">
            <label class="text-klein text-grau">Betrag (Brutto)</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="number" step="0.01" min="0" class="input-field" id="zahlungBetrag" placeholder="0,00" oninput="updateZahlungVorschau()">
                <button class="btn btn-small btn-secondary" onclick="setZahlungVollstaendig()">Vollständig</button>
            </div>
        </div>

        <div class="form-group" style="margin-bottom: 1rem;">
            <label class="text-klein text-grau">Zahlungsdatum</label>
            <input type="date" class="input-field" id="zahlungDatum">
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label class="text-klein text-grau">Notiz (optional)</label>
            <input type="text" class="input-field" id="zahlungNotiz" placeholder="z.B. Überweisung, Verwendungszweck...">
        </div>

        <!-- Vorschau Aufschlüsselung -->
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 4px;">
            <div class="text-klein text-grau" style="margin-bottom: 0.5rem;">Aufschlüsselung</div>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.25rem;">
                <span class="text-normal">Netto:</span>
                <span class="text-normal text-right" id="zahlungVorschauNetto">0,00 €</span>
                <span class="text-normal">USt (19%):</span>
                <span class="text-normal text-right" id="zahlungVorschauUst">0,00 €</span>
                <span class="text-normal--fett">Brutto:</span>
                <span class="text-normal--fett text-right" id="zahlungVorschauBrutto">0,00 €</span>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeZahlungModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveZahlung()">Zahlung speichern</button>
    </div>
</div>

    <!-- Seiten-spezifische Daten und Initialisierung -->
    <script>
        // ========== SUPABASE KONFIGURATION ==========
        const SUPABASE_URL = 'https://lgztglycqtiwcmiydxnm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnenRnbHljcXRpd2NtaXlkeG5tIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzgwNzYxNSwiZXhwIjoyMDc5MzgzNjE1fQ.54kSk9ZSUdQt6LKYWkblqgR6Sjev80W80qkNHYEbPgk';

        // ========== HILFSFUNKTIONEN ==========
        function formatCurrency(val) {
            return (parseFloat(val) || 0).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
        }

        // ========== DATEN (werden aus DB geladen) ==========
        let drkKundenData = [];
        let drkRechnungenData = [];
        let drkFaelligData = [];

        const testBestandData = []; // Nicht verwendet für DRK
        const testHistoryData = {}; // Nicht verwendet für DRK

        // Kontext-Daten
        const contextData = {
            type: 'kunde',
            name: 'DRK Abrechnungen'
        };

        // ========== DB LADE-FUNKTIONEN ==========

        // Tab "Kunden": Lädt Kunden mit aggregierten Entitlements
        async function loadDrkKundenFromDB() {
            try {
                // 1. Kunden laden
                const kundenRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/customers?select=id,full_name,name,kd_id&order=full_name`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const kunden = await kundenRes.json();
                if (!Array.isArray(kunden)) throw new Error('Keine Kunden gefunden');

                // 2. Entitlements laden (status = faellig oder ausstehend)
                const entRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/record_entitlements?select=customer_id,verguetungsjahr,jahreseuros,status&status=in.(faellig,ausstehend)`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const entitlements = await entRes.json();

                // 3. Records zählen pro Kunde (aktiv)
                const recRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/records?select=customer_id,yearly_amount&record_status=eq.aktiv&deleted_at=is.null`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const records = await recRes.json();

                // 4. Aggregieren
                const kundenMap = {};
                kunden.forEach(k => {
                    kundenMap[k.id] = {
                        id: k.id,
                        name: k.full_name || k.name,
                        kundenId: k.kd_id || '-',
                        vj1: 0, vj2: 0, vj3: 0, vj4: 0, vj5: 0,
                        mitglieder: 0,
                        jahreseuros: 0
                    };
                });

                // Entitlements aggregieren
                if (Array.isArray(entitlements)) {
                    entitlements.forEach(e => {
                        if (kundenMap[e.customer_id]) {
                            const vj = `vj${e.verguetungsjahr}`;
                            kundenMap[e.customer_id][vj] += parseFloat(e.jahreseuros) || 0;
                        }
                    });
                }

                // Records aggregieren
                if (Array.isArray(records)) {
                    records.forEach(r => {
                        if (kundenMap[r.customer_id]) {
                            kundenMap[r.customer_id].mitglieder++;
                            kundenMap[r.customer_id].jahreseuros += parseFloat(r.yearly_amount) || 0;
                        }
                    });
                }

                // Format für Tabelle
                const formatEuro = (v) => v.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
                drkKundenData = Object.values(kundenMap)
                    .filter(k => k.mitglieder > 0 || k.vj1 > 0 || k.vj2 > 0)
                    .map(k => ({
                        id: k.id,
                        name: k.name,
                        kundenId: k.kundenId,
                        rechnungsnummer: '-',
                        auftragsnummer: '-',
                        offeneProv1Jahr: formatEuro(k.vj1),
                        stornopufferProzent: '10%',
                        stornopufferSumme: formatEuro(k.vj1 * 0.1),
                        offeneProv2Jahr: formatEuro(k.vj2),
                        offeneProv3Jahr: formatEuro(k.vj3),
                        offeneProv4Jahr: formatEuro(k.vj4),
                        offeneProv5Jahr: formatEuro(k.vj5),
                        provisionGesamt: formatEuro(k.vj1 + k.vj2 + k.vj3 + k.vj4 + k.vj5),
                        mitglieder: k.mitglieder,
                        jahreseuros: formatEuro(k.jahreseuros)
                    }));

            } catch (err) {
                console.error('Fehler beim Laden der DRK-Kunden:', err);
                drkKundenData = [];
            }
        }

        // Tab "Rechnungen": Lädt DRK-Rechnungen (wo customer_id gesetzt ist)
        async function loadDrkRechnungenFromDB() {
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoices?select=id,invoice_number,customer_id,customers(full_name,name),abrechnungstyp,total_payout,status,created_at&customer_id=not.is.null&order=created_at.desc`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const rechnungen = await res.json();

                const formatEuro = (v) => (parseFloat(v) || 0).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
                const formatDate = (d) => d ? new Date(d).toLocaleDateString('de-DE') : '-';

                drkRechnungenData = Array.isArray(rechnungen) ? rechnungen.map(r => ({
                    id: r.id,
                    rechnungsnummer: r.invoice_number || '-',
                    kunde: r.customers?.full_name || r.customers?.name || '-',
                    typ: r.abrechnungstyp || '-',
                    brutto: formatEuro(r.total_payout),
                    status: r.status || 'entwurf',
                    datum: formatDate(r.created_at)
                })) : [];

            } catch (err) {
                console.error('Fehler beim Laden der DRK-Rechnungen:', err);
                drkRechnungenData = [];
            }
        }

        // Tab "Fällig": Lädt fällige Entitlements
        async function loadDrkFaelligFromDB() {
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/record_entitlements?select=id,customer_id,customers(full_name,name),campaign_id,campaigns(name,year),verguetungsjahr,jahreseuros,faellig_ab&status=eq.faellig&order=faellig_ab`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const faellig = await res.json();

                const formatEuro = (v) => (parseFloat(v) || 0).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
                const formatDate = (d) => d ? new Date(d).toLocaleDateString('de-DE') : '-';
                const vjToTyp = { 1: 'EA', 2: '1JA', 3: '2JA', 4: '3JA', 5: '4JA' };

                // Gruppieren nach Kunde + Kampagne + VJ
                const grouped = {};
                if (Array.isArray(faellig)) {
                    faellig.forEach(f => {
                        const key = `${f.customer_id}|${f.campaign_id}|${f.verguetungsjahr}`;
                        if (!grouped[key]) {
                            grouped[key] = {
                                id: key,
                                customerId: f.customer_id,
                                campaignId: f.campaign_id,
                                vj: f.verguetungsjahr,
                                kunde: f.customers?.full_name || f.customers?.name || '-',
                                kampagne: f.campaigns?.name ? `${f.campaigns.name}${f.campaigns.year ? ' (' + f.campaigns.year + ')' : ''}` : '-',
                                typ: vjToTyp[f.verguetungsjahr] || 'ZA',
                                faelligSeit: f.faellig_ab,
                                betragCa: 0,
                                count: 0
                            };
                        }
                        grouped[key].betragCa += parseFloat(f.jahreseuros) || 0;
                        grouped[key].count++;
                        if (f.faellig_ab && (!grouped[key].faelligSeit || f.faellig_ab < grouped[key].faelligSeit)) {
                            grouped[key].faelligSeit = f.faellig_ab;
                        }
                    });
                }

                drkFaelligData = Object.values(grouped).map(g => ({
                    id: g.id,
                    customerId: g.customerId,
                    campaignId: g.campaignId,
                    vj: g.vj,
                    kunde: g.kunde,
                    kampagne: g.kampagne,
                    typ: g.typ,
                    faelligSeit: formatDate(g.faelligSeit),
                    betragCa: formatEuro(g.betragCa)
                }));

            } catch (err) {
                console.error('Fehler beim Laden der fälligen Abrechnungen:', err);
                drkFaelligData = [];
            }
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', async () => {
            // Tabs initialisieren
            initTabs('.kw-tab', '.kw-tab-content');

            // Zentrale Modals initialisieren
            ModalTemplates.init(['storno', 'columns', 'edit', 'import', 'export']);

            // Abrechnungs-eigene Render-Funktion (überschreibt die aus main.js)
            window.renderRecordsTable = renderAbrechnungenTable;

            // Daten aus DB laden (parallel)
            await Promise.all([
                loadDrkKundenFromDB(),
                loadDrkRechnungenFromDB(),
                loadDrkFaelligFromDB()
            ]);

            // Datensätze-System initialisieren mit echten Daten
            initDatensaetze({
                recordsData: drkKundenData,
                bestandData: testBestandData,
                historyData: testHistoryData,
                contextData: contextData
            });

            // Tab-Badges aktualisieren
            document.getElementById('recordsBadge').textContent = drkKundenData.length;
            document.getElementById('rechnungenBadge').textContent = drkRechnungenData.filter(r => r.status === 'offen').length;
            document.getElementById('faelligBadge').textContent = drkFaelligData.length;

            // Neue Tabs rendern
            renderRechnungenTable();
            renderFaelligTable();

            // Register toolbar config with shell (Import/Export for data tables)
            registerToolbarConfig();
        });

        // Abrechnungs-spezifische Render-Funktion (Kopie aus main.js mit zusätzlichen Spalten)
        function renderAbrechnungenTable() {
            let filtered;
            if (currentFilter === 'all') {
                filtered = recordsData;
            } else {
                filtered = recordsData.filter(d => d.typ === currentFilter);
            }

            // DRK-spezifische Spalten-Konfiguration
            const config = [
                { id: 'name', visible: true },
                { id: 'kundenId', visible: true },
                { id: 'rechnungsnummer', visible: true },
                { id: 'auftragsnummer', visible: true },
                { id: 'offeneProv1Jahr', visible: true },
                { id: 'stornopufferProzent', visible: true },
                { id: 'stornopufferSumme', visible: true },
                { id: 'offeneProv2Jahr', visible: true },
                { id: 'offeneProv3Jahr', visible: true },
                { id: 'offeneProv4Jahr', visible: true },
                { id: 'offeneProv5Jahr', visible: true },
                { id: 'provisionGesamt', visible: true },
                { id: 'mitglieder', visible: true },
                { id: 'jahreseuros', visible: true }
            ];

            // Header-Definitionen für DRK-Abrechnungen
            const headerDefs = {
                name: { class: 'col-name text-left', label: 'Name' },
                kundenId: { class: 'col-m text-left', label: 'Kunden ID' },
                rechnungsnummer: { class: 'col-m text-left', label: 'Rechnungsnummer' },
                auftragsnummer: { class: 'col-m text-left', label: 'Auftr. / Vertr.-Nr.' },
                offeneProv1Jahr: { class: 'col-m text-right', label: 'Offene Prov. 1. Jahr' },
                stornopufferProzent: { class: 'col-s text-right', label: 'Stornopuffer (%)' },
                stornopufferSumme: { class: 'col-m text-right', label: 'Stornopuffer Summe' },
                offeneProv2Jahr: { class: 'col-m text-right', label: 'Offene Prov. 2. Jahr' },
                offeneProv3Jahr: { class: 'col-m text-right', label: 'Offene Prov. 3. Jahr' },
                offeneProv4Jahr: { class: 'col-m text-right', label: 'Offene Prov. 4. Jahr' },
                offeneProv5Jahr: { class: 'col-m text-right', label: 'Offene Prov. 5. Jahr' },
                provisionGesamt: { class: 'col-m text-right', label: 'Provision gesamt' },
                mitglieder: { class: 'col-s text-right', label: 'Mitglieder' },
                jahreseuros: { class: 'col-m text-right', label: 'Jahreseuros' }
            };

            // Header rendern
            const sort = currentSort.records;
            const thead = document.getElementById('recordsTableHead');
            if (!thead) return;

            let headerHtml = `<tr>
                <th class="checkbox-cell">
                    <input type="checkbox" class="row-checkbox" id="selectAllRecords" onclick="TableCheckbox.toggleSelectAll(this, 'recordsTableBody'); updateSelectionUI('recordsTableBody')">
                </th>
                <th class="action-cell"></th>`;

            config.forEach(col => {
                const def = headerDefs[col.id];
                if (def) {
                    const display = col.visible ? '' : 'display:none;';
                    const sortClass = sort.col === col.id ? (sort.direction === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                    headerHtml += `<th class="sortable ${def.class} ${sortClass}" data-col="${col.id}" style="${display}" onclick="sortTable('records', '${col.id}')">
                        ${def.label}
                        <span class="sort-arrows">
                            <span class="icon icon--pfeil-auf arrow-up"></span>
                            <span class="icon icon--pfeil-ab arrow-down"></span>
                        </span>
                    </th>`;
                }
            });
            headerHtml += `<th class="col-spacer"></th></tr>`;
            thead.innerHTML = headerHtml;

            const body = document.getElementById('recordsTableBody');
            if (!body) return;

            body.innerHTML = filtered.map(d => {
                // DRK-spezifische Spalten-Daten
                const colData = {
                    name: { class: 'col-name text-left', html: d.name },
                    kundenId: { class: 'col-m text-left', html: d.kundenId || '-' },
                    rechnungsnummer: { class: 'col-m text-left', html: d.rechnungsnummer || '-' },
                    auftragsnummer: { class: 'col-m text-left', html: d.auftragsnummer || '-' },
                    offeneProv1Jahr: { class: 'col-m text-right', html: d.offeneProv1Jahr || '-' },
                    stornopufferProzent: { class: 'col-s text-right', html: d.stornopufferProzent || '-' },
                    stornopufferSumme: { class: 'col-m text-right', html: d.stornopufferSumme || '-' },
                    offeneProv2Jahr: { class: 'col-m text-right', html: d.offeneProv2Jahr || '-' },
                    offeneProv3Jahr: { class: 'col-m text-right', html: d.offeneProv3Jahr || '-' },
                    offeneProv4Jahr: { class: 'col-m text-right', html: d.offeneProv4Jahr || '-' },
                    offeneProv5Jahr: { class: 'col-m text-right', html: d.offeneProv5Jahr || '-' },
                    provisionGesamt: { class: 'col-m text-right', html: d.provisionGesamt || '-' },
                    mitglieder: { class: 'col-s text-right', html: d.mitglieder || '0' },
                    jahreseuros: { class: 'col-m text-right', html: d.jahreseuros || '-' }
                };

                // Spalten in konfigurierter Reihenfolge rendern
                let columnsHtml = '';
                config.forEach(col => {
                    const data = colData[col.id];
                    if (data) {
                        const display = col.visible ? '' : 'display:none;';
                        columnsHtml += `<td class="${data.class}" style="${display}">${data.html}</td>`;
                    }
                });

                return `
                <tr data-id="${d.id}" data-typ="${d.typ}">
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" onchange="handleRowCheckbox(this, 'records', '${d.id}')">
                    </td>
                    <td class="action-cell">
                        <div class="dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown(this, 'records', '${d.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" onclick="handleDropdownAction('edit', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Bearbeiten
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" onclick="handleDropdownAction('mail', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    E-Mail senden
                                </div>
                                <div class="dropdown-item" onclick="handleDropdownAction('createInvoice', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Abrechnung erstellen
                                </div>
                                <div class="dropdown-item" onclick="handleDropdownAction('showInvoices', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                    Rechnungen anzeigen
                                </div>
                            </div>
                        </div>
                    </td>
                    ${columnsHtml}
                    <td class="col-spacer"></td>
                </tr>
            `;
            }).join('');

            // Totals-Row rendern
            renderAbrechnungenTotals(filtered, config);
        }

        // DRK-spezifische Totals-Funktion
        function renderAbrechnungenTotals(data, config) {
            const tfoot = document.getElementById('recordsTableFoot');
            if (!tfoot) return;

            // Summen berechnen
            const parseEuro = (val) => {
                if (typeof val === 'number') return val;
                return parseFloat(String(val || '0').replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            };

            const totalProv1 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv1Jahr), 0);
            const totalStornopuffer = data.reduce((sum, d) => sum + parseEuro(d.stornopufferSumme), 0);
            const totalProv2 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv2Jahr), 0);
            const totalProv3 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv3Jahr), 0);
            const totalProv4 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv4Jahr), 0);
            const totalProv5 = data.reduce((sum, d) => sum + parseEuro(d.offeneProv5Jahr), 0);
            const totalProvGesamt = data.reduce((sum, d) => sum + parseEuro(d.provisionGesamt), 0);
            const totalMitglieder = data.reduce((sum, d) => sum + (parseInt(d.mitglieder) || 0), 0);
            const totalJahreseuros = data.reduce((sum, d) => sum + parseEuro(d.jahreseuros), 0);

            const formatEuro = (val) => val.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';

            // Totals-Definitionen für DRK
            const totalsDefs = {
                name: { class: 'col-name text-left', html: `Gesamt<span class="totals-count">(${data.length})</span>` },
                kundenId: { class: 'col-m text-left', html: '' },
                rechnungsnummer: { class: 'col-m text-left', html: '' },
                auftragsnummer: { class: 'col-m text-left', html: '' },
                offeneProv1Jahr: { class: 'col-m text-right', html: formatEuro(totalProv1) },
                stornopufferProzent: { class: 'col-s text-right', html: '' },
                stornopufferSumme: { class: 'col-m text-right', html: formatEuro(totalStornopuffer) },
                offeneProv2Jahr: { class: 'col-m text-right', html: formatEuro(totalProv2) },
                offeneProv3Jahr: { class: 'col-m text-right', html: formatEuro(totalProv3) },
                offeneProv4Jahr: { class: 'col-m text-right', html: formatEuro(totalProv4) },
                offeneProv5Jahr: { class: 'col-m text-right', html: formatEuro(totalProv5) },
                provisionGesamt: { class: 'col-m text-right', html: formatEuro(totalProvGesamt) },
                mitglieder: { class: 'col-s text-right', html: totalMitglieder.toString() },
                jahreseuros: { class: 'col-m text-right', html: formatEuro(totalJahreseuros) }
            };

            let totalsHtml = '<tr class="totals-row">';
            totalsHtml += '<td class="checkbox-cell"></td>';
            totalsHtml += '<td class="action-cell"></td>';

            config.forEach(col => {
                const def = totalsDefs[col.id];
                if (def) {
                    const display = col.visible ? '' : 'display:none;';
                    totalsHtml += `<td class="${def.class}" style="${display}">${def.html}</td>`;
                }
            });
            totalsHtml += '<td class="col-spacer"></td></tr>';
            tfoot.innerHTML = totalsHtml;
        }

        // Register toolbar buttons for data tables
        function registerToolbarConfig() {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'registerToolbar',
                    config: {
                        actionButtons: [
                            { id: 'import', text: 'Import', icon: 'upload', action: 'openImportModal' },
                            { id: 'export', text: 'Export', icon: 'download', action: 'openExportModal', primary: true }
                        ]
                    }
                }, '*');
            }
        }

        // Listen for toolbar actions from shell
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'toolbarAction') {
                if (e.data.action === 'openImportModal' && typeof openImportModal === 'function') {
                    openImportModal();
                } else if (e.data.action === 'openExportModal' && typeof openExportModal === 'function') {
                    openExportModal();
                }
            }
        });

        // ========== RECHNUNGEN TAB ==========
        function renderRechnungenTable() {
            const thead = document.getElementById('rechnungenTableHead');
            const tbody = document.getElementById('rechnungenTableBody');
            if (!thead || !tbody) return;

            // Filter anwenden
            const statusFilter = document.getElementById('filterRechnungStatus')?.value || 'all';
            const typFilter = document.getElementById('filterRechnungTyp')?.value || 'all';

            let filtered = drkRechnungenData;
            if (statusFilter !== 'all') filtered = filtered.filter(r => r.status === statusFilter);
            if (typFilter !== 'all') filtered = filtered.filter(r => r.typ === typFilter);

            // Header
            thead.innerHTML = `<tr>
                <th class="checkbox-cell"><input type="checkbox" class="row-checkbox" onclick="toggleSelectAllRechnungen(this)"></th>
                <th class="action-cell"></th>
                <th class="col-m text-left">Rechnungsnr.</th>
                <th class="col-name text-left">Kunde</th>
                <th class="col-s text-center">Typ</th>
                <th class="col-m text-right">Brutto</th>
                <th class="col-s text-center">Status</th>
                <th class="col-s text-left">Datum</th>
                <th class="col-spacer"></th>
            </tr>`;

            // Body
            tbody.innerHTML = filtered.map(r => {
                const statusClass = {
                    'entwurf': 'badge--neutral',
                    'offen': 'badge--warning',
                    'geplant': 'badge--info',
                    'bezahlt': 'badge--success',
                    'storniert': 'badge--danger'
                }[r.status] || '';

                return `<tr data-id="${r.id}">
                    <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" onchange="updateRechnungenSelection()"></td>
                    <td class="action-cell">
                        <div class="dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown(this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" onclick="openRechnungDetails('${r.id}')">Details anzeigen</div>
                                <div class="dropdown-item" onclick="downloadRechnungPdf('${r.id}')">PDF Download</div>
                                <div class="dropdown-item" onclick="sendRechnungEmail('${r.id}')">E-Mail senden</div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" onclick="erfasseZahlung('${r.id}')">Zahlung erfassen</div>
                                <div class="dropdown-divider"></div>
                                ${r.status === 'entwurf'
                                    ? `<div class="dropdown-item danger" onclick="deleteRechnung('${r.id}')">Löschen</div>`
                                    : `<div class="dropdown-item warning" onclick="storniereRechnung('${r.id}')">Stornieren</div>`}
                            </div>
                        </div>
                    </td>
                    <td class="col-m text-left">${r.rechnungsnummer}</td>
                    <td class="col-name text-left">${r.kunde}</td>
                    <td class="col-s text-center"><span class="badge badge--small">${r.typ}</span></td>
                    <td class="col-m text-right">${r.brutto}</td>
                    <td class="col-s text-center"><span class="badge badge--small ${statusClass}">${r.status}</span></td>
                    <td class="col-s text-left">${r.datum}</td>
                    <td class="col-spacer"></td>
                </tr>`;
            }).join('');
        }

        function filterRechnungen() {
            renderRechnungenTable();
        }

        function toggleSelectAllRechnungen(checkbox) {
            const checkboxes = document.querySelectorAll('#rechnungenTableBody .row-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateRechnungenSelection();
        }

        function updateRechnungenSelection() {
            const checkboxes = document.querySelectorAll('#rechnungenTableBody .row-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('rechnungenSelectedCount').textContent = count;
            document.getElementById('rechnungenSelectionGroup').classList.toggle('anzeigenfeld--hidden', count === 0);
        }

        // ========== DRK-SPEZIFISCHE DROPDOWN-AKTIONEN ==========
        // Überschreibt handleDropdownAction für DRK-spezifische Aktionen
        const originalHandleDropdownAction = window.handleDropdownAction;
        window.handleDropdownAction = function(action, dropdownMenu) {
            const type = dropdownMenu.dataset.type;
            const id = dropdownMenu.dataset.id;
            closeAllDropdowns();

            // DRK-spezifische Aktionen
            if (action === 'createInvoice') {
                openCreateInvoiceModal(id);
                return;
            }
            if (action === 'showInvoices') {
                showInvoicesForRecord(id);
                return;
            }

            // Standard-Aktionen an original weiterleiten
            if (originalHandleDropdownAction) {
                originalHandleDropdownAction(action, dropdownMenu);
            }
        };

        // Abrechnung erstellen für Record
        function openCreateInvoiceModal(recordId) {
            console.log('Abrechnung erstellen für Record:', recordId);
            // TODO: Modal öffnen mit vorausgewähltem Record
            alert('Abrechnung erstellen für Record: ' + recordId + '\n(Modal wird in Phase 8 implementiert)');
        }

        // Rechnungen für Record anzeigen (wechselt zu Tab Rechnungen mit Filter)
        function showInvoicesForRecord(recordId) {
            console.log('Rechnungen anzeigen für Record:', recordId);
            // Zum Rechnungen-Tab wechseln
            document.querySelector('[data-tab="rechnungen"]').click();
            // TODO: Filter auf diesen Record setzen
            alert('Rechnungen für Record: ' + recordId + '\n(Filter wird in Phase 6 implementiert)');
        }

        // Verbindung Dropdown → Modal
        function openRechnungDetails(id) { openRechnungDetailModal(id); }
        async function downloadRechnungPdf(id) {
            try {
                // Rechnung mit Kunde laden
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoices?select=*,customers(*),campaigns(name)&id=eq.${id}`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const data = await res.json();
                if (!data || data.length === 0) throw new Error('Rechnung nicht gefunden');
                await generateDrkPDF(data[0], 'download');
            } catch (err) {
                console.error('Fehler beim PDF-Download:', err);
                alert('Fehler: ' + err.message);
            }
        }
        async function sendRechnungEmail(id) {
            try {
                // Bestätigung
                if (!confirm('Rechnung per E-Mail an den Schatzmeister senden?')) return;

                // Rechnung laden
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoices?select=*,customers(*)&id=eq.${id}`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const data = await res.json();
                if (!data || data.length === 0) {
                    alert('Rechnung nicht gefunden');
                    return;
                }
                const rechnung = data[0];

                // PDF als Base64 generieren
                const pdfBase64 = await generateDrkPDF(rechnung, 'base64');
                const filename = `Rechnung_${rechnung.invoice_number || 'Entwurf'}.pdf`;

                // Edge Function aufrufen
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/send-drk-invoice-email`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify({
                            invoice_id: id,
                            pdf_base64: pdfBase64,
                            pdf_filename: filename
                        })
                    }
                );

                const result = await response.json();

                if (result.success) {
                    alert(`E-Mail erfolgreich gesendet an: ${result.recipient}`);
                    await loadRechnungen();
                } else {
                    alert('Fehler: ' + (result.error || 'Unbekannter Fehler'));
                }
            } catch (err) {
                console.error('Fehler beim E-Mail-Versand:', err);
                alert('Fehler beim E-Mail-Versand: ' + err.message);
            }
        }
        async function erfasseZahlung(id) { await openZahlungModalDirekt(id); }
        async function storniereRechnung(id) {
            if (!confirm('Rechnung wirklich stornieren?')) return;
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoices?id=eq.${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ status: 'storniert' })
                    }
                );
                if (res.ok) {
                    alert('Rechnung storniert');
                    await loadDrkRechnungenFromDB();
                    renderRechnungenTable();
                } else {
                    throw new Error('Stornierung fehlgeschlagen');
                }
            } catch (err) {
                console.error('Fehler beim Stornieren:', err);
                alert('Fehler: ' + err.message);
            }
        }

        async function deleteRechnung(id) {
            if (!confirm('Entwurf wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) return;
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoices?id=eq.${id}&status=eq.entwurf`,
                    {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Prefer': 'return=minimal'
                        }
                    }
                );
                if (res.ok) {
                    alert('Entwurf gelöscht');
                    await loadDrkRechnungenFromDB();
                    renderRechnungenTable();
                } else {
                    throw new Error('Löschen fehlgeschlagen');
                }
            } catch (err) {
                console.error('Fehler beim Löschen:', err);
                alert('Fehler: ' + err.message);
            }
        }
        async function sendMailRechnungen() {
            const checkboxes = document.querySelectorAll('#rechnungenTableBody .row-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Bitte mindestens eine Rechnung auswählen');
                return;
            }

            const ids = Array.from(checkboxes).map(cb => cb.closest('tr').dataset.id);

            if (!confirm(`${ids.length} Rechnung(en) per E-Mail senden?`)) return;

            let success = 0;
            let failed = 0;
            const errors = [];

            for (const id of ids) {
                try {
                    // Rechnung laden
                    const res = await fetch(
                        `${SUPABASE_URL}/rest/v1/invoices?select=*,customers(*)&id=eq.${id}`,
                        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                    );
                    const data = await res.json();
                    if (!data || data.length === 0) {
                        failed++;
                        errors.push(`ID ${id}: Nicht gefunden`);
                        continue;
                    }
                    const rechnung = data[0];

                    // PDF als Base64 generieren
                    const pdfBase64 = await generateDrkPDF(rechnung, 'base64');
                    const filename = `Rechnung_${rechnung.invoice_number || 'Entwurf'}.pdf`;

                    // Edge Function aufrufen
                    const response = await fetch(
                        `${SUPABASE_URL}/functions/v1/send-drk-invoice-email`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            },
                            body: JSON.stringify({
                                invoice_id: id,
                                pdf_base64: pdfBase64,
                                pdf_filename: filename
                            })
                        }
                    );

                    const result = await response.json();
                    if (result.success) {
                        success++;
                    } else {
                        failed++;
                        errors.push(`${rechnung.invoice_number || id}: ${result.error}`);
                    }
                } catch (err) {
                    failed++;
                    errors.push(`ID ${id}: ${err.message}`);
                }
            }

            // Zusammenfassung
            let msg = `${success} von ${ids.length} E-Mails gesendet.`;
            if (errors.length > 0) {
                msg += `\n\nFehler:\n${errors.join('\n')}`;
            }
            alert(msg);
            await loadRechnungen();
        }
        async function downloadPdfZip() {
            // Ausgewählte Rechnungen holen
            const checkboxes = document.querySelectorAll('#rechnungenTableBody .row-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Bitte mindestens eine Rechnung auswählen');
                return;
            }

            const ids = Array.from(checkboxes).map(cb => cb.closest('tr').dataset.id);

            try {
                // Info an User
                if (ids.length > 1) {
                    alert(`${ids.length} PDFs werden nacheinander erstellt...`);
                }

                // PDFs nacheinander generieren
                for (const id of ids) {
                    const res = await fetch(
                        `${SUPABASE_URL}/rest/v1/invoices?select=*,customers(*),campaigns(name)&id=eq.${id}`,
                        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                    );
                    const data = await res.json();
                    if (data && data.length > 0) {
                        await generateDrkPDF(data[0], 'download');
                        // Kurze Pause zwischen Downloads
                        if (ids.length > 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                }
            } catch (err) {
                console.error('Fehler beim PDF-Download:', err);
                alert('Fehler: ' + err.message);
            }
        }

        // ========== FÄLLIG TAB ==========
        function renderFaelligTable() {
            const thead = document.getElementById('faelligTableHead');
            const tbody = document.getElementById('faelligTableBody');
            if (!thead || !tbody) return;

            // Header
            thead.innerHTML = `<tr>
                <th class="checkbox-cell"><input type="checkbox" class="row-checkbox" onclick="toggleSelectAllFaellig(this)"></th>
                <th class="action-cell"></th>
                <th class="col-name text-left">Kunde</th>
                <th class="col-m text-left">Kampagne</th>
                <th class="col-s text-center">Typ</th>
                <th class="col-s text-left">Fällig seit</th>
                <th class="col-m text-right">Betrag (ca.)</th>
                <th class="col-spacer"></th>
            </tr>`;

            // Body
            tbody.innerHTML = drkFaelligData.map(f => `<tr data-id="${f.id}">
                <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" onchange="updateFaelligSelection()"></td>
                <td class="action-cell">
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="12" cy="5" r="1"></circle>
                                <circle cx="12" cy="19" r="1"></circle>
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <div class="dropdown-item" onclick="openAbrechnungFromFaellig('${f.id}')">Abrechnung erstellen</div>
                        </div>
                    </div>
                </td>
                <td class="col-name text-left">${f.kunde}</td>
                <td class="col-m text-left">${f.kampagne}</td>
                <td class="col-s text-center"><span class="badge badge--small badge--warning">${f.typ}</span></td>
                <td class="col-s text-left">${f.faelligSeit}</td>
                <td class="col-m text-right">${f.betragCa}</td>
                <td class="col-spacer"></td>
            </tr>`).join('');
        }

        function toggleSelectAllFaellig(checkbox) {
            const checkboxes = document.querySelectorAll('#faelligTableBody .row-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateFaelligSelection();
        }

        function updateFaelligSelection() {
            const checkboxes = document.querySelectorAll('#faelligTableBody .row-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('faelligSelectedCount').textContent = count;
            document.getElementById('faelligSelectionGroup').classList.toggle('anzeigenfeld--hidden', count === 0);
        }

        function openAbrechnungFromFaellig(faelligId) {
            console.log('openAbrechnungFromFaellig aufgerufen mit ID:', faelligId);
            closeAllDropdowns();
            // Fällig-Eintrag finden
            const faelligEintrag = drkFaelligData.find(f => f.id === faelligId);
            console.log('Gefundener Eintrag:', faelligEintrag);
            if (!faelligEintrag) {
                alert('Eintrag nicht gefunden');
                return;
            }
            // Modal öffnen mit vorausgewählten Daten
            openAbrechnungModal(faelligEintrag);
        }

        function createAbrechnungFromFaellig() {
            const selected = document.querySelectorAll('#faelligTableBody .row-checkbox:checked');
            if (selected.length === 0) {
                alert('Bitte mindestens einen Eintrag auswählen');
                return;
            }
            // Ersten ausgewählten Eintrag für Pre-Select holen (ID ist auf der TR-Zeile)
            const firstId = selected[0].closest('tr').dataset.id;
            const faelligEintrag = drkFaelligData.find(f => f.id === firstId);
            // Modal öffnen mit vorausgewählten Daten
            openAbrechnungModal(faelligEintrag);
        }

        // ========== ABRECHNUNG MODAL ==========
        let abrechnungCurrentStep = 1;
        let abrechnungData = {};

        // Dynamisch geladene Kunden und Kampagnen
        let kundenData = [];
        let kampagnenData = {};
        let vertraegeData = {};

        // Kunden aus Supabase laden
        async function loadKundenFromDB() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/customers?select=id,name,full_name,kd_id,empfaenger_typ,rechnungsart&order=name`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                if (!response.ok) throw new Error('Fehler beim Laden der Kunden');
                const kunden = await response.json();
                kundenData = kunden.map(k => ({
                    id: k.id,
                    name: k.full_name || k.name,
                    kundenId: k.kd_id || '-',
                    empfaengerTyp: k.empfaenger_typ || '',
                    rechnungsart: k.rechnungsart || 'zusammen'
                }));
            } catch (err) {
                console.error('Fehler beim Laden der Kunden:', err);
                kundenData = [];
            }
        }

        // Kampagnen für einen Kunden laden (über customer_areas → campaign_areas → campaigns)
        async function loadKampagnenFromDB(customerId) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/customer_areas?customer_id=eq.${customerId}&select=campaign_areas(campaign_id,campaigns(id,name,year,status))`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                if (!response.ok) throw new Error('Fehler beim Laden der Kampagnen');
                const areas = await response.json();

                // Kampagnen aus verschachtelter Struktur extrahieren (eindeutig)
                const kampagnenMap = new Map();
                areas.forEach(area => {
                    (area.campaign_areas || []).forEach(ca => {
                        if (ca.campaigns && !kampagnenMap.has(ca.campaigns.id)) {
                            kampagnenMap.set(ca.campaigns.id, {
                                id: ca.campaigns.id,
                                name: ca.campaigns.name + (ca.campaigns.year ? ` (${ca.campaigns.year})` : ''),
                                status: ca.campaigns.status
                            });
                        }
                    });
                });

                kampagnenData[customerId] = Array.from(kampagnenMap.values());
            } catch (err) {
                console.error('Fehler beim Laden der Kampagnen:', err);
                kampagnenData[customerId] = [];
            }
        }

        // Verträge (Rahmenverträge) für einen Kunden laden
        async function loadVertraegeFromDB(customerId) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/customer_contracts?customer_id=eq.${customerId}&contract_type=eq.rahmenvertrag&select=id,name,vertragsnummer&order=upload_date.desc`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                if (!response.ok) throw new Error('Fehler beim Laden der Verträge');
                const vertraege = await response.json();
                vertraegeData[customerId] = vertraege.map(v => ({
                    id: v.id,
                    name: v.name || 'Rahmenvertrag',
                    vertragsnummer: v.vertragsnummer || '-'
                }));
            } catch (err) {
                console.error('Fehler beim Laden der Verträge:', err);
                vertraegeData[customerId] = [];
            }
        }

        // Cache für geladene Einsatzgebiete (campaign_areas)
        let cachedCampaignAreas = {};
        // Cache für geladene Records
        let cachedRecords = [];

        // Kalender-Modal für Zeitraum-Auswahl öffnen
        function openAbrZeitraumCalendar(event) {
            event.preventDefault();
            CalendarModal.open((fromDE, toDE, displayText) => {
                // Deutsches Format "DD.MM.YYYY" in ISO "YYYY-MM-DD" konvertieren
                const fromParts = fromDE.split('.');
                const toParts = toDE.split('.');
                const fromISO = `${fromParts[2]}-${fromParts[1]}-${fromParts[0]}`;
                const toISO = `${toParts[2]}-${toParts[1]}-${toParts[0]}`;
                document.getElementById('abrZeitraumVon').value = fromISO;
                document.getElementById('abrZeitraumBis').value = toISO;
            });
        }

        async function openAbrechnungModal(faelligEintrag = null) {
            abrechnungCurrentStep = 1;
            abrechnungData = {};

            // Kunden laden aus Supabase
            const kundeSelect = document.getElementById('abrKunde');
            kundeSelect.innerHTML = '<option value="">Lade Kunden...</option>';

            await loadKundenFromDB();

            kundeSelect.innerHTML = '<option value="">Bitte auswählen...</option>' +
                kundenData.map(k => `<option value="${k.id}">${k.name} (${k.kundenId})</option>`).join('');

            // Reset andere Felder
            document.getElementById('abrKampagne').innerHTML = '<option value="">Erst Kunde wählen...</option>';
            document.getElementById('abrKampagne').disabled = true;
            document.getElementById('abrVertrag').innerHTML = '<option value="">Erst Kunde wählen...</option>';
            document.getElementById('abrVertrag').disabled = true;
            document.getElementById('abrEinsatzgebiete').innerHTML = '<div class="text-klein text-secondary">Erst Kampagne wählen...</div>';
            document.getElementById('abrKundeInfo').textContent = '';

            // Abrechnungstyp auf Standard (ZA) zurücksetzen
            document.getElementById('abrTyp').value = 'ZA';

            // Zeitraum vorbelegen (letzter Monat)
            const heute = new Date();
            const letzterMonatStart = new Date(heute.getFullYear(), heute.getMonth() - 1, 1);
            const letzterMonatEnde = new Date(heute.getFullYear(), heute.getMonth(), 0);
            document.getElementById('abrZeitraumVon').value = letzterMonatStart.toISOString().split('T')[0];
            document.getElementById('abrZeitraumBis').value = letzterMonatEnde.toISOString().split('T')[0];

            // UI zurücksetzen
            showAbrechnungStep(1);

            // Modal öffnen
            document.getElementById('abrechnungModal').classList.add('active');

            // Falls Eintrag übergeben wurde, Felder vorausfüllen
            if (faelligEintrag && faelligEintrag.customerId) {
                console.log('Vorauswahl Kunde:', faelligEintrag.customerId);
                console.log('Verfügbare Optionen:', Array.from(kundeSelect.options).map(o => o.value));
                kundeSelect.value = faelligEintrag.customerId;
                console.log('Gesetzter Wert:', kundeSelect.value);
                await loadKampagnenForKunde();

                // Kampagne vorauswählen
                if (faelligEintrag.campaignId) {
                    document.getElementById('abrKampagne').value = faelligEintrag.campaignId;
                    await loadEinsatzgebiete();
                }

                // Abrechnungstyp vorauswählen
                console.log('Vorauswahl Typ:', faelligEintrag.typ);
                if (faelligEintrag.typ) {
                    document.getElementById('abrTyp').value = faelligEintrag.typ;
                    console.log('Gesetzter Typ:', document.getElementById('abrTyp').value);
                }
            }
        }

        function closeAbrechnungModal() {
            document.getElementById('abrechnungModal').classList.remove('active');
        }

        async function loadKampagnenForKunde() {
            const kundeId = document.getElementById('abrKunde').value;
            const kampagneSelect = document.getElementById('abrKampagne');
            const vertragSelect = document.getElementById('abrVertrag');

            if (!kundeId) {
                kampagneSelect.innerHTML = '<option value="">Erst Kunde wählen...</option>';
                kampagneSelect.disabled = true;
                vertragSelect.innerHTML = '<option value="">Erst Kunde wählen...</option>';
                vertragSelect.disabled = true;
                document.getElementById('abrKundeInfo').textContent = '';
                document.getElementById('abrEinsatzgebiete').innerHTML = '<div class="text-klein text-secondary">Erst Kampagne wählen...</div>';
                return;
            }

            // Kunde-Info anzeigen (inkl. Rechnungsart)
            const kunde = kundenData.find(k => k.id === kundeId);
            const rechnungsartLabel = kunde?.rechnungsart === 'getrennt' ? 'Getrennt' : 'Zusammen';
            document.getElementById('abrKundeInfo').textContent = kunde ? `${kunde.empfaengerTyp ? 'Typ: ' + kunde.empfaengerTyp + ' | ' : ''}Rechnung: ${rechnungsartLabel}` : '';

            // Rechnungsart für spätere Verwendung speichern
            abrechnungData.rechnungsart = kunde?.rechnungsart || 'zusammen';

            // Kampagnen und Verträge parallel laden
            kampagneSelect.innerHTML = '<option value="">Lade...</option>';
            vertragSelect.innerHTML = '<option value="">Lade...</option>';

            await Promise.all([
                loadKampagnenFromDB(kundeId),
                loadVertraegeFromDB(kundeId)
            ]);

            // Kampagnen anzeigen
            const kampagnen = kampagnenData[kundeId] || [];
            kampagneSelect.innerHTML = '<option value="">Bitte auswählen...</option>' +
                kampagnen.map(k => `<option value="${k.id}">${k.name}</option>`).join('');
            kampagneSelect.disabled = kampagnen.length === 0;

            // Verträge anzeigen
            const vertraege = vertraegeData[kundeId] || [];
            vertragSelect.innerHTML = '<option value="">Bitte auswählen...</option>' +
                vertraege.map(v => `<option value="${v.vertragsnummer}">${v.vertragsnummer} (${v.name})</option>`).join('');
            vertragSelect.disabled = vertraege.length === 0;

            document.getElementById('abrEinsatzgebiete').innerHTML = '<div class="text-klein text-secondary">Erst Kampagne wählen...</div>';
        }

        async function loadEinsatzgebiete() {
            const kampagneId = document.getElementById('abrKampagne').value;
            const container = document.getElementById('abrEinsatzgebiete');

            if (!kampagneId) {
                container.innerHTML = '<div class="text-klein text-secondary">Erst Kampagne wählen...</div>';
                return;
            }

            container.innerHTML = '<div class="text-klein text-secondary">Lade Einsatzgebiete...</div>';

            try {
                // Campaign_areas aus Supabase laden
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/campaign_areas?campaign_id=eq.${kampagneId}&select=id,name,provision_sondierung,provision_regular,einwohnerzahl,stornopuffer,kosten`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );

                if (!response.ok) throw new Error('Fehler beim Laden der Einsatzgebiete');

                const gebiete = await response.json();
                cachedCampaignAreas[kampagneId] = gebiete;

                if (gebiete.length === 0) {
                    container.innerHTML = '<div class="text-klein text-secondary">Keine Einsatzgebiete gefunden</div>';
                    return;
                }

                // Checkboxen rendern (MG/JE wird bei Vorschau aus Records berechnet)
                container.innerHTML = gebiete.map(g => `
                    <label class="checkbox-item">
                        <input type="checkbox" value="${g.id}"
                            data-name="${g.name}"
                            data-provision-sondierung='${JSON.stringify(g.provision_sondierung || {j1:80,j2:50,j3:30,j4:0,j5:0,limit:100,limitType:"mg"})}'
                            data-provision-regular='${JSON.stringify(g.provision_regular || {j1:60,j2:40,j3:20,j4:0,j5:0})}'
                            data-einwohnerzahl="${g.einwohnerzahl || 0}"
                            data-stornopuffer="${g.stornopuffer || 10}"
                            data-kosten='${JSON.stringify(g.kosten || {})}'
                            checked>
                        <span class="checkbox-label">${g.name}</span>
                        <span class="checkbox-info text-klein" id="gebietInfo_${g.id}">Lade MG...</span>
                    </label>
                `).join('');

                // Event-Listener für Checkboxen
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', updateEinsatzgebieteInfo);
                });

                // MG/JE Info initial leer (wird bei Zeitraum-Änderung aktualisiert)
                updateEinsatzgebieteInfo();

            } catch (error) {
                console.error('Fehler:', error);
                container.innerHTML = '<div class="text-klein text-error">Fehler beim Laden der Einsatzgebiete</div>';
            }
        }

        function updateEinsatzgebieteInfo() {
            const checkboxes = document.querySelectorAll('#abrEinsatzgebiete input[type="checkbox"]:checked');
            document.getElementById('abrEinsatzgebieteInfo').textContent =
                `Ausgewählt: ${checkboxes.length} Gebiete (MG/JE wird bei Vorschau berechnet)`;
        }

        function updateStornopufferVisibility() {
            const typ = document.getElementById('abrTyp').value;
            // Stornopuffer nur bei ZA
            const showStornopuffer = (typ === 'ZA');
            // Kann später für UI-Anpassungen genutzt werden
        }

        function showAbrechnungStep(step) {
            abrechnungCurrentStep = step;

            // Tabs aktualisieren
            document.getElementById('tabAuswahl').classList.toggle('active', step === 1);
            document.getElementById('tabVorschau').classList.toggle('active', step === 2);

            // Inhalt anzeigen
            document.getElementById('abrechnungStep1').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('abrechnungStep2').style.display = step === 2 ? 'block' : 'none';

            // Buttons aktualisieren
            document.getElementById('abrBtnZurueck').style.display = step === 2 ? 'inline-flex' : 'none';
            document.getElementById('abrBtnWeiter').style.display = step === 1 ? 'inline-flex' : 'none';
            document.getElementById('abrBtnEntwurf').style.display = step === 2 ? 'inline-flex' : 'none';
            document.getElementById('abrBtnErstellen').style.display = step === 2 ? 'inline-flex' : 'none';

            // Subtitle aktualisieren
            document.getElementById('abrechnungModalSubtitle').textContent =
                step === 1 ? 'Schritt 1: Auswahl' : 'Schritt 2: Vorschau';
        }

        async function abrechnungWeiter() {
            // Validierung
            if (!document.getElementById('abrKunde').value) {
                alert('Bitte Kunde auswählen');
                return;
            }
            if (!document.getElementById('abrKampagne').value) {
                alert('Bitte Kampagne auswählen');
                return;
            }

            const selectedGebiete = document.querySelectorAll('#abrEinsatzgebiete input[type="checkbox"]:checked');
            if (selectedGebiete.length === 0) {
                alert('Bitte mindestens ein Einsatzgebiet auswählen');
                return;
            }

            const zeitraumVon = document.getElementById('abrZeitraumVon').value;
            const zeitraumBis = document.getElementById('abrZeitraumBis').value;

            if (!zeitraumVon || !zeitraumBis) {
                alert('Bitte Zeitraum auswählen');
                return;
            }

            // Gebiete-IDs für Query sammeln
            const gebietIds = Array.from(selectedGebiete).map(cb => cb.value);

            // Button deaktivieren während Laden
            const weiterBtn = document.getElementById('abrBtnWeiter');
            weiterBtn.disabled = true;
            weiterBtn.textContent = 'Lade Records...';

            try {
                // Records für Zeitraum und Gebiete laden
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/records?campaign_area_id=in.(${gebietIds.join(',')})&start_date=gte.${zeitraumVon}&start_date=lte.${zeitraumBis}&record_status=eq.aktiv&select=id,campaign_area_id,yearly_amount,last_name,first_name,start_date`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );

                if (!response.ok) throw new Error('Fehler beim Laden der Records');

                cachedRecords = await response.json();

                // Daten sammeln inkl. provision_sondierung etc.
                abrechnungData = {
                    kundeId: document.getElementById('abrKunde').value,
                    kundeName: document.getElementById('abrKunde').options[document.getElementById('abrKunde').selectedIndex].text,
                    kampagneId: document.getElementById('abrKampagne').value,
                    kampagneName: document.getElementById('abrKampagne').options[document.getElementById('abrKampagne').selectedIndex].text,
                    typ: document.getElementById('abrTyp').value,
                    vertrag: document.getElementById('abrVertrag').value,
                    zeitraumVon: zeitraumVon,
                    zeitraumBis: zeitraumBis,
                    einsatzgebiete: Array.from(selectedGebiete).map(cb => ({
                        id: cb.value,
                        name: cb.dataset.name,
                        provisionSondierung: JSON.parse(cb.dataset.provisionSondierung),
                        provisionRegular: JSON.parse(cb.dataset.provisionRegular),
                        einwohnerzahl: parseInt(cb.dataset.einwohnerzahl) || 0,
                        stornopuffer: parseInt(cb.dataset.stornopuffer) || 10,
                        kosten: JSON.parse(cb.dataset.kosten || '{}')
                    })),
                    records: cachedRecords
                };

                // Vorschau generieren
                generateVorschau();

                // Schritt 2 anzeigen
                showAbrechnungStep(2);

            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Laden der Records: ' + error.message);
            } finally {
                weiterBtn.disabled = false;
                weiterBtn.textContent = 'Weiter';
            }
        }

        function abrechnungZurueck() {
            showAbrechnungStep(1);
        }

        function generateVorschau() {
            const typ = abrechnungData.typ;
            const gebiete = abrechnungData.einsatzgebiete;
            const records = abrechnungData.records || [];
            const rechnungsart = abrechnungData.rechnungsart || 'zusammen';

            // Bei "getrennt": Separate Rechnungen pro Einsatzgebiet
            if (rechnungsart === 'getrennt' && gebiete.length > 1) {
                generateVorschauGetrennt();
                return;
            }

            // Vergütungsjahr bestimmen (j1 für ZA/EA, j2 für 1JA, etc.)
            const vjKey = typ === 'ZA' || typ === 'EA' ? 'j1' :
                          typ === '1JA' ? 'j2' :
                          typ === '2JA' ? 'j3' :
                          typ === '3JA' ? 'j4' : 'j5';

            // Sondierung/Regular Listen pro Gebiet erstellen
            const sondierungPositionen = [];
            const regularPositionen = [];

            gebiete.forEach(gebiet => {
                // Records für dieses Gebiet filtern
                let gebietRecords = records.filter(r => r.campaign_area_id === gebiet.id);

                // Nach yearly_amount ASC sortieren (kleinste zuerst → Sondierung)
                gebietRecords.sort((a, b) => (a.yearly_amount || 0) - (b.yearly_amount || 0));

                // Sondierungslimit berechnen
                const limitConfig = gebiet.provisionSondierung || { limit: 100, limitType: 'mg' };
                let sondierungLimit = limitConfig.limit || 100;

                if (limitConfig.limitType === 'prozent' && gebiet.einwohnerzahl > 0) {
                    // Prozent der Einwohnerzahl
                    sondierungLimit = Math.floor(gebiet.einwohnerzahl * (limitConfig.limit / 100));
                }

                // Aufteilung: erste X → Sondierung, Rest → Regular
                const sondierungRecords = gebietRecords.slice(0, sondierungLimit);
                const regularRecords = gebietRecords.slice(sondierungLimit);

                // Nach Familienname sortieren
                sondierungRecords.sort((a, b) => (a.last_name || '').localeCompare(b.last_name || ''));
                regularRecords.sort((a, b) => (a.last_name || '').localeCompare(b.last_name || ''));

                // Provisionsätze aus campaign_area
                const satzSondierung = gebiet.provisionSondierung?.[vjKey] || 0;
                const satzRegular = gebiet.provisionRegular?.[vjKey] || 0;

                // Aggregierte Position für Sondierung
                if (sondierungRecords.length > 0) {
                    const sondJe = sondierungRecords.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
                    sondierungPositionen.push({
                        gebietId: gebiet.id,
                        gebietName: gebiet.name,
                        mg: sondierungRecords.length,
                        je: sondJe,
                        satz: satzSondierung,
                        betrag: sondJe * satzSondierung / 100,
                        records: sondierungRecords
                    });
                }

                // Aggregierte Position für Regular
                if (regularRecords.length > 0) {
                    const regJe = regularRecords.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
                    regularPositionen.push({
                        gebietId: gebiet.id,
                        gebietName: gebiet.name,
                        mg: regularRecords.length,
                        je: regJe,
                        satz: satzRegular,
                        betrag: regJe * satzRegular / 100,
                        records: regularRecords
                    });
                }
            });

            // Stornopuffer (nur bei ZA)
            const stornopufferProzent = typ === 'ZA' ? (gebiete[0]?.stornopuffer || 10) : 0;

            // Gesamtsummen
            const totalMg = records.length;
            const totalJe = records.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
            const sondMg = sondierungPositionen.reduce((sum, p) => sum + p.mg, 0);
            const regMg = regularPositionen.reduce((sum, p) => sum + p.mg, 0);

            // Summary rendern
            document.getElementById('vorschauSummary').innerHTML = `
                <div class="vorschau-header">
                    <div class="vorschau-info">
                        <span class="text-normal--fett">${abrechnungData.kundeName}</span>
                        <span class="text-klein">${abrechnungData.kampagneName} | ${abrechnungData.vertrag}</span>
                    </div>
                    <div class="vorschau-badge">
                        <span class="badge badge--small badge--warning">${typ}</span>
                    </div>
                </div>
                <div class="vorschau-stats">
                    <div class="vorschau-stat">
                        <span class="text-klein">Zeitraum</span>
                        <span class="text-normal--fett">${formatDate(abrechnungData.zeitraumVon)} - ${formatDate(abrechnungData.zeitraumBis)}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Einsatzgebiete</span>
                        <span class="text-normal--fett">${gebiete.length}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Gesamt MG</span>
                        <span class="text-normal--fett">${totalMg} (${sondMg} Sond. / ${regMg} Reg.)</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Gesamt JE</span>
                        <span class="text-normal--fett">${totalJe.toLocaleString('de-DE')} €</span>
                    </div>
                </div>
            `;

            // Tabelle generieren
            let rows = [];
            let posNr = 1;
            let zwischensumme = 0;

            // Sondierung
            if (sondierungPositionen.length > 0) {
                const sondSatz = sondierungPositionen[0]?.satz || 0;
                rows.push(`<tr class="table-section-header"><td colspan="6" class="text-normal--fett">Sonderkonditionen (${sondSatz}%)</td></tr>`);
                sondierungPositionen.forEach(pos => {
                    zwischensumme += pos.betrag;
                    rows.push(`<tr>
                        <td>A${posNr++}</td>
                        <td>${pos.gebietName}</td>
                        <td class="text-right">${pos.mg}</td>
                        <td class="text-right">${pos.je.toLocaleString('de-DE')}</td>
                        <td class="text-center">${pos.satz}</td>
                        <td class="text-right">${pos.betrag.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                    </tr>`);
                });
            }

            // Regular
            if (regularPositionen.length > 0) {
                const regSatz = regularPositionen[0]?.satz || 0;
                rows.push(`<tr class="table-section-header"><td colspan="6" class="text-normal--fett">Regularkonditionen (${regSatz}%)</td></tr>`);
                regularPositionen.forEach(pos => {
                    zwischensumme += pos.betrag;
                    rows.push(`<tr>
                        <td>B${posNr++}</td>
                        <td>${pos.gebietName}</td>
                        <td class="text-right">${pos.mg}</td>
                        <td class="text-right">${pos.je.toLocaleString('de-DE')}</td>
                        <td class="text-center">${pos.satz}</td>
                        <td class="text-right">${pos.betrag.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                    </tr>`);
                });
            }

            // Zubuchungen aus Kostenübernahmen sammeln
            const zubuchungen = [];
            const kostenTypLabels = {
                kfz: 'KFZ-Pauschale',
                unterkunft: 'Unterkunft',
                verpflegung: 'Verpflegung',
                kleidung: 'Kleidung',
                ausweise: 'Ausweise'
            };

            gebiete.forEach(gebiet => {
                const kosten = gebiet.kosten || {};
                Object.keys(kosten).forEach(typ => {
                    const k = kosten[typ];
                    if (k && k.aktiv && parseFloat(k.betrag) > 0) {
                        const label = k.art === 'frei' && k.artFrei ? k.artFrei : kostenTypLabels[typ] || typ;
                        zubuchungen.push({
                            gebietName: gebiet.name,
                            typ: typ,
                            bezeichnung: label,
                            betrag: parseFloat(k.betrag) || 0
                        });
                    }
                });
            });

            // Zubuchungen zur Tabelle hinzufügen
            if (zubuchungen.length > 0) {
                rows.push(`<tr class="table-section-header"><td colspan="6" class="text-normal--fett">Zubuchungen</td></tr>`);
                zubuchungen.forEach(z => {
                    zwischensumme += z.betrag;
                    rows.push(`<tr>
                        <td>Z${posNr++}</td>
                        <td>${z.bezeichnung} (${z.gebietName})</td>
                        <td class="text-right">-</td>
                        <td class="text-right">-</td>
                        <td class="text-center">-</td>
                        <td class="text-right">${z.betrag.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                    </tr>`);
                });
            }

            // Falls keine Records
            if (rows.length === 0) {
                rows.push(`<tr><td colspan="6" class="text-center text-secondary">Keine Datensätze im gewählten Zeitraum</td></tr>`);
            }

            document.getElementById('vorschauTableBody').innerHTML = rows.join('');

            // Footer mit Summen
            const stornopuffer = zwischensumme * stornopufferProzent / 100;
            const netto = zwischensumme - stornopuffer;
            const ust = netto * 0.19;
            const brutto = netto + ust;

            let footerRows = [`<tr class="table-sum-row">
                <td colspan="5" class="text-right text-normal--fett">Zwischensumme</td>
                <td class="text-right text-normal--fett">${zwischensumme.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
            </tr>`];

            if (stornopufferProzent > 0) {
                footerRows.push(`<tr>
                    <td colspan="5" class="text-right">Stornopuffer (${stornopufferProzent}%)</td>
                    <td class="text-right text-error">-${stornopuffer.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
                </tr>`);
            }

            footerRows.push(`<tr>
                <td colspan="5" class="text-right text-normal--fett">Netto</td>
                <td class="text-right text-normal--fett">${netto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
            </tr>`);
            footerRows.push(`<tr>
                <td colspan="5" class="text-right">USt (19%)</td>
                <td class="text-right">${ust.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
            </tr>`);
            footerRows.push(`<tr class="table-total-row">
                <td colspan="5" class="text-right text-normal--fett">Brutto</td>
                <td class="text-right text-normal--fett">${brutto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
            </tr>`);

            document.getElementById('vorschauTableFoot').innerHTML = footerRows.join('');

            // Daten für Speichern merken
            abrechnungData.sondierungPositionen = sondierungPositionen;
            abrechnungData.regularPositionen = regularPositionen;
            abrechnungData.zubuchungen = zubuchungen;
            abrechnungData.zwischensumme = zwischensumme;
            abrechnungData.stornopuffer = stornopuffer;
            abrechnungData.stornopufferProzent = stornopufferProzent;
            abrechnungData.netto = netto;
            abrechnungData.ust = ust;
            abrechnungData.brutto = brutto;
        }

        // Vorschau für getrennte Rechnungen (eine pro Einsatzgebiet)
        function generateVorschauGetrennt() {
            const typ = abrechnungData.typ;
            const gebiete = abrechnungData.einsatzgebiete;
            const records = abrechnungData.records || [];

            const vjKey = typ === 'ZA' || typ === 'EA' ? 'j1' :
                          typ === '1JA' ? 'j2' :
                          typ === '2JA' ? 'j3' :
                          typ === '3JA' ? 'j4' : 'j5';

            // Rechnungen pro Gebiet berechnen
            const rechnungen = [];
            let gesamtBrutto = 0;

            gebiete.forEach(gebiet => {
                const gebietRecords = records.filter(r => r.campaign_area_id === gebiet.id);
                if (gebietRecords.length === 0) return;

                gebietRecords.sort((a, b) => (a.yearly_amount || 0) - (b.yearly_amount || 0));

                const limitConfig = gebiet.provisionSondierung || { limit: 100, limitType: 'mg' };
                let sondierungLimit = limitConfig.limit || 100;
                if (limitConfig.limitType === 'prozent' && gebiet.einwohnerzahl > 0) {
                    sondierungLimit = Math.floor(gebiet.einwohnerzahl * (limitConfig.limit / 100));
                }

                const sondierungRecords = gebietRecords.slice(0, sondierungLimit);
                const regularRecords = gebietRecords.slice(sondierungLimit);

                const satzSondierung = gebiet.provisionSondierung?.[vjKey] || 0;
                const satzRegular = gebiet.provisionRegular?.[vjKey] || 0;
                const stornopufferProzent = typ === 'ZA' ? (gebiet.stornopuffer || 10) : 0;

                const sondJe = sondierungRecords.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
                const regJe = regularRecords.reduce((sum, r) => sum + (r.yearly_amount || 0), 0);
                const sondBetrag = sondJe * satzSondierung / 100;
                const regBetrag = regJe * satzRegular / 100;

                // Zubuchungen für dieses Gebiet
                const kostenTypLabels = {
                    kfz: 'KFZ-Pauschale',
                    unterkunft: 'Unterkunft',
                    verpflegung: 'Verpflegung',
                    kleidung: 'Kleidung',
                    ausweise: 'Ausweise'
                };
                const gebietZubuchungen = [];
                const kosten = gebiet.kosten || {};
                Object.keys(kosten).forEach(typ => {
                    const k = kosten[typ];
                    if (k && k.aktiv && parseFloat(k.betrag) > 0) {
                        const label = k.art === 'frei' && k.artFrei ? k.artFrei : kostenTypLabels[typ] || typ;
                        gebietZubuchungen.push({
                            typ: typ,
                            bezeichnung: label,
                            betrag: parseFloat(k.betrag) || 0
                        });
                    }
                });
                const zubuchungenBetrag = gebietZubuchungen.reduce((sum, z) => sum + z.betrag, 0);

                const zwischensumme = sondBetrag + regBetrag + zubuchungenBetrag;
                const stornopuffer = zwischensumme * stornopufferProzent / 100;
                const netto = zwischensumme - stornopuffer;
                const ust = netto * 0.19;
                const brutto = netto + ust;

                gesamtBrutto += brutto;

                rechnungen.push({
                    gebiet: gebiet,
                    mgSond: sondierungRecords.length,
                    mgReg: regularRecords.length,
                    mgTotal: gebietRecords.length,
                    sondBetrag,
                    regBetrag,
                    zubuchungen: gebietZubuchungen,
                    zubuchungenBetrag,
                    zwischensumme,
                    stornopuffer,
                    stornopufferProzent,
                    netto,
                    ust,
                    brutto,
                    records: gebietRecords
                });
            });

            // Summary mit Hinweis auf getrennte Rechnungen
            document.getElementById('vorschauSummary').innerHTML = `
                <div class="vorschau-header">
                    <div class="vorschau-info">
                        <span class="text-normal--fett">${abrechnungData.kundeName}</span>
                        <span class="text-klein">${abrechnungData.kampagneName} | ${abrechnungData.vertrag}</span>
                    </div>
                    <div class="vorschau-badge">
                        <span class="badge badge--small badge--warning">${typ}</span>
                        <span class="badge badge--small badge--info">Getrennt: ${rechnungen.length} Rechnungen</span>
                    </div>
                </div>
                <div class="vorschau-stats">
                    <div class="vorschau-stat">
                        <span class="text-klein">Zeitraum</span>
                        <span class="text-normal--fett">${formatDate(abrechnungData.zeitraumVon)} - ${formatDate(abrechnungData.zeitraumBis)}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Rechnungen</span>
                        <span class="text-normal--fett">${rechnungen.length}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Gesamt MG</span>
                        <span class="text-normal--fett">${records.length}</span>
                    </div>
                    <div class="vorschau-stat">
                        <span class="text-klein">Gesamt Brutto</span>
                        <span class="text-normal--fett">${gesamtBrutto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</span>
                    </div>
                </div>
            `;

            // Tabelle: Liste der einzelnen Rechnungen
            let rows = [];
            rows.push(`<tr class="table-section-header"><td colspan="6" class="text-normal--fett">Einzelne Rechnungen</td></tr>`);

            rechnungen.forEach((r, idx) => {
                rows.push(`<tr>
                    <td>${idx + 1}</td>
                    <td>${r.gebiet.name}</td>
                    <td class="text-right">${r.mgTotal} (${r.mgSond}/${r.mgReg})</td>
                    <td class="text-right">${r.zwischensumme.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                    <td class="text-right">${r.stornopufferProzent > 0 ? '-' + r.stornopuffer.toLocaleString('de-DE', {minimumFractionDigits: 2}) : '-'}</td>
                    <td class="text-right text-normal--fett">${r.brutto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
                </tr>`);
            });

            if (rechnungen.length === 0) {
                rows.push(`<tr><td colspan="6" class="text-center text-secondary">Keine Datensätze im gewählten Zeitraum</td></tr>`);
            }

            document.getElementById('vorschauTableBody').innerHTML = rows.join('');

            // Footer mit Gesamtsumme
            document.getElementById('vorschauTableFoot').innerHTML = `
                <tr class="table-total-row">
                    <td colspan="5" class="text-right text-normal--fett">Gesamt (${rechnungen.length} Rechnungen)</td>
                    <td class="text-right text-normal--fett">${gesamtBrutto.toLocaleString('de-DE', {minimumFractionDigits: 2})} €</td>
                </tr>
            `;

            // Daten für Speichern
            abrechnungData.rechnungen = rechnungen;
            abrechnungData.gesamtBrutto = gesamtBrutto;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('de-DE');
        }

        async function saveAbrechnungEntwurf() {
            await saveAbrechnung('entwurf');
        }

        async function saveAbrechnungErstellen() {
            await saveAbrechnung('offen');
        }

        async function saveAbrechnung(status) {
            const btn = status === 'entwurf'
                ? document.getElementById('abrBtnEntwurf')
                : document.getElementById('abrBtnErstellen');

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Speichert...';

            try {
                // Daten für RPC vorbereiten
                const rpcData = {
                    kundeId: abrechnungData.kundeId,
                    kampagneId: abrechnungData.kampagneId,
                    typ: abrechnungData.typ,
                    zeitraumVon: abrechnungData.zeitraumVon,
                    zeitraumBis: abrechnungData.zeitraumBis,
                    vertrag: abrechnungData.vertrag,
                    rechnungsart: abrechnungData.rechnungsart,
                    status: status
                };

                // Je nach Rechnungsart unterschiedliche Daten
                if (abrechnungData.rechnungsart === 'zusammen') {
                    rpcData.sondierungPositionen = abrechnungData.sondierungPositionen || [];
                    rpcData.regularPositionen = abrechnungData.regularPositionen || [];
                    rpcData.zubuchungen = abrechnungData.zubuchungen || [];
                    rpcData.zwischensumme = abrechnungData.zwischensumme;
                    rpcData.stornopuffer = abrechnungData.stornopuffer;
                    rpcData.stornopufferProzent = abrechnungData.stornopufferProzent;
                    rpcData.netto = abrechnungData.netto;
                    rpcData.ust = abrechnungData.ust;
                    rpcData.brutto = abrechnungData.brutto;
                } else {
                    rpcData.rechnungen = abrechnungData.rechnungen || [];
                }

                // RPC aufrufen
                const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/create_drk_invoice`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ input_data: rpcData })
                });

                const result = await res.json();

                if (result.success) {
                    const count = result.count || 1;
                    const statusText = status === 'entwurf' ? 'als Entwurf gespeichert' : 'erstellt';
                    alert(`${count} Rechnung(en) ${statusText}`);
                    closeAbrechnungModal();

                    // Tabellen neu laden
                    await Promise.all([
                        loadDrkRechnungenFromDB(),
                        loadDrkFaelligFromDB()
                    ]);
                    renderRechnungenTable();
                    renderFaelligTable();

                    // Badges aktualisieren
                    document.getElementById('rechnungenBadge').textContent =
                        drkRechnungenData.filter(r => r.status === 'offen').length;
                    document.getElementById('faelligBadge').textContent = drkFaelligData.length;
                } else {
                    throw new Error(result.error || 'Unbekannter Fehler');
                }
            } catch (err) {
                console.error('Fehler beim Speichern:', err);
                alert('Fehler: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Update: openCreateInvoiceModal öffnet Modal mit vorausgewähltem Kunden
        function openCreateInvoiceModal(customerId) {
            openAbrechnungModal({ customerId: customerId });
        }

        // ========== RECHNUNG DETAIL MODAL ==========
        let currentRechnungId = null;
        let currentRechnungData = null;

        async function openRechnungDetailModal(rechnungId) {
            currentRechnungId = rechnungId;
            document.getElementById('rechnungDetailModal').classList.add('active');
            await loadRechnungDetails(rechnungId);
        }

        function closeRechnungDetailModal() {
            document.getElementById('rechnungDetailModal').classList.remove('active');
            currentRechnungId = null;
            currentRechnungData = null;
        }

        async function loadRechnungDetails(rechnungId) {
            try {
                // Rechnung mit Kunde und Kampagne laden
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoices?select=*,customers(full_name,name),campaigns(name)&id=eq.${rechnungId}`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const data = await res.json();
                if (!data || data.length === 0) throw new Error('Rechnung nicht gefunden');

                currentRechnungData = data[0];
                const r = currentRechnungData;

                // Kopfbereich füllen
                document.getElementById('detailRechnungsnummer').textContent = r.invoice_number || '(Entwurf)';
                document.getElementById('detailStatus').value = r.status || 'entwurf';
                document.getElementById('detailKunde').textContent = r.customers?.full_name || r.customers?.name || '-';
                document.getElementById('detailKampagne').textContent = r.campaigns?.name || '-';
                document.getElementById('detailTyp').textContent = formatAbrechnungstyp(r.abrechnungstyp, r.ist_sondierung);
                document.getElementById('detailZeitraum').textContent = formatDate(r.period_start) + ' - ' + formatDate(r.period_end);
                document.getElementById('detailVertrag').textContent = r.vertragsnummer || '-';
                document.getElementById('detailErstellt').textContent = formatDate(r.created_at);

                // Positionen aus calculation_data
                renderDetailPositionen(r.calculation_data);

                // Summen
                const netto = parseFloat(r.netto_auszahlung) || 0;
                const ust = parseFloat(r.vat_amount) || 0;
                const brutto = parseFloat(r.total_payout) || 0;
                const zwischensumme = r.calculation_data?.zwischensumme || netto;
                const stornopuffer = r.calculation_data?.stornopuffer || 0;

                document.getElementById('detailZwischensumme').textContent = formatEuro(zwischensumme);
                if (stornopuffer > 0) {
                    document.getElementById('detailStornopufferLabel').style.display = '';
                    document.getElementById('detailStornopuffer').style.display = '';
                    document.getElementById('detailStornopuffer').textContent = '-' + formatEuro(stornopuffer);
                } else {
                    document.getElementById('detailStornopufferLabel').style.display = 'none';
                    document.getElementById('detailStornopuffer').style.display = 'none';
                }
                document.getElementById('detailNetto').textContent = formatEuro(netto);
                document.getElementById('detailUst').textContent = formatEuro(ust);
                document.getElementById('detailBrutto').textContent = formatEuro(brutto);

                // Zahlungen laden
                await loadRechnungZahlungen(rechnungId, brutto);

            } catch (err) {
                console.error('Fehler beim Laden der Rechnung:', err);
                alert('Fehler: ' + err.message);
            }
        }

        function formatAbrechnungstyp(typ, istSondierung) {
            const typMap = { 'ZA': 'Zwischenabrechnung', 'EA': 'Endabrechnung', '1JA': '1. Jahresabrechnung', '2JA': '2. Jahresabrechnung', '3JA': '3. Jahresabrechnung', '4JA': '4. Jahresabrechnung' };
            let text = typMap[typ] || typ || '-';
            if (istSondierung === true) text += ' (Sondierung)';
            else if (istSondierung === false) text += ' (Regular)';
            return text;
        }

        function formatEuro(val) {
            return (parseFloat(val) || 0).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
        }

        function renderDetailPositionen(calcData) {
            const tbody = document.getElementById('detailPositionen');
            if (!calcData) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-grau">Keine Positionsdaten</td></tr>';
                return;
            }

            let html = '';

            // Fall 1: Zusammen (positionen Array)
            if (calcData.positionen && Array.isArray(calcData.positionen)) {
                calcData.positionen.forEach(p => {
                    html += `<tr>
                        <td>${p.gebietName || '-'}</td>
                        <td class="text-right">${p.mg || 0}</td>
                        <td class="text-right">${formatEuro(p.je)}</td>
                        <td class="text-right">${p.satz || 0}%</td>
                        <td class="text-right">${formatEuro(p.betrag)}</td>
                    </tr>`;
                });
            }
            // Fall 2: Getrennt (einzelnes Gebiet)
            else if (calcData.gebiet) {
                if (calcData.mgSond > 0) {
                    html += `<tr>
                        <td>${calcData.gebiet} (Sondierung)</td>
                        <td class="text-right">${calcData.mgSond}</td>
                        <td class="text-right">-</td>
                        <td class="text-right">-</td>
                        <td class="text-right">${formatEuro(calcData.sondBetrag)}</td>
                    </tr>`;
                }
                if (calcData.mgReg > 0) {
                    html += `<tr>
                        <td>${calcData.gebiet} (Regular)</td>
                        <td class="text-right">${calcData.mgReg}</td>
                        <td class="text-right">-</td>
                        <td class="text-right">-</td>
                        <td class="text-right">${formatEuro(calcData.regBetrag)}</td>
                    </tr>`;
                }
            }

            tbody.innerHTML = html || '<tr><td colspan="5" class="text-grau">Keine Positionen</td></tr>';
        }

        async function loadRechnungZahlungen(rechnungId, brutto) {
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoice_payments?select=*&invoice_id=eq.${rechnungId}&order=zahlungsdatum`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const zahlungen = await res.json();

                const tbody = document.getElementById('detailZahlungen');
                let gezahlt = 0;

                if (!zahlungen || zahlungen.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-grau">Keine Zahlungen</td></tr>';
                } else {
                    tbody.innerHTML = zahlungen.map(z => {
                        gezahlt += parseFloat(z.betrag_brutto) || 0;
                        return `<tr>
                            <td>${formatDate(z.zahlungsdatum)}</td>
                            <td class="text-right">${formatCurrency(z.betrag_brutto)}</td>
                            <td>${z.notiz || '-'}</td>
                        </tr>`;
                    }).join('');
                }

                const offen = brutto - gezahlt;
                document.getElementById('detailOffen').textContent = formatCurrency(offen);
                document.getElementById('detailOffen').style.color = offen > 0 ? 'var(--rot)' : 'var(--gruen)';

            } catch (err) {
                console.error('Fehler beim Laden der Zahlungen:', err);
            }
        }

        async function updateRechnungStatus() {
            if (!currentRechnungId) return;
            const newStatus = document.getElementById('detailStatus').value;

            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoices?id=eq.${currentRechnungId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ status: newStatus })
                    }
                );

                if (res.ok) {
                    // Rechnungsnummer neu laden (wird bei "offen" generiert)
                    await loadRechnungDetails(currentRechnungId);
                    // Tabelle aktualisieren
                    await loadDrkRechnungenFromDB();
                    renderRechnungenTable();
                    document.getElementById('rechnungenBadge').textContent =
                        drkRechnungenData.filter(r => r.status === 'offen').length;
                } else {
                    throw new Error('Status konnte nicht geändert werden');
                }
            } catch (err) {
                console.error('Fehler beim Ändern des Status:', err);
                alert('Fehler: ' + err.message);
            }
        }

        // ========== ZAHLUNG MODAL ==========
        let currentZahlungRechnung = null; // Speichert aktuelle Rechnungsdaten für Zahlung

        // Direkt aus Dropdown aufrufen (lädt Daten selbst)
        async function openZahlungModalDirekt(rechnungId) {
            try {
                // Rechnung aus DB laden
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoices?select=*,customers(name)&id=eq.${rechnungId}`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const data = await res.json();
                if (!data || data.length === 0) return;
                const rechnung = data[0];

                // Zahlungen laden um offenen Betrag zu berechnen
                const zahlRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoice_payments?select=betrag_brutto&invoice_id=eq.${rechnungId}`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const zahlungen = await zahlRes.json();
                const bezahlt = (zahlungen || []).reduce((sum, z) => sum + (parseFloat(z.betrag_brutto) || 0), 0);

                const brutto = parseFloat(rechnung.total_payout) || 0;
                const offen = brutto - bezahlt;

                currentZahlungRechnung = {
                    id: rechnungId,
                    rechnungsnummer: rechnung.invoice_number || '-',
                    brutto: brutto,
                    offen: offen,
                    bezahlt: bezahlt
                };

                // Modal befüllen
                document.getElementById('zahlungRechnungsnr').textContent = currentZahlungRechnung.rechnungsnummer;
                document.getElementById('zahlungRechnungsbetrag').textContent = formatCurrency(currentZahlungRechnung.brutto);
                document.getElementById('zahlungBereitsBezahlt').textContent = formatCurrency(currentZahlungRechnung.bezahlt);
                document.getElementById('zahlungOffen').textContent = formatCurrency(currentZahlungRechnung.offen);

                // Inputs zurücksetzen
                document.getElementById('zahlungBetrag').value = '';
                document.getElementById('zahlungDatum').value = new Date().toISOString().split('T')[0];
                document.getElementById('zahlungNotiz').value = '';
                updateZahlungVorschau();

                document.getElementById('zahlungModal').classList.add('active');
            } catch (err) {
                console.error('Fehler beim Laden der Rechnung:', err);
                alert('Fehler: ' + err.message);
            }
        }

        // Aus Detail-Modal aufrufen (nutzt bereits geladene Daten)
        function openZahlungModal() {
            if (!currentRechnungId) return;

            // Rechnungsdaten aus dem Detail-Modal holen
            const rechnung = drkRechnungenData.find(r => r.id === currentRechnungId);
            if (!rechnung) return;

            currentZahlungRechnung = {
                id: currentRechnungId,
                rechnungsnummer: document.getElementById('detailRechnungsnummer').textContent,
                brutto: parseFloat(document.getElementById('detailBrutto').textContent.replace(/[^\d,-]/g, '').replace(',', '.')) || 0,
                offen: parseFloat(document.getElementById('detailOffen').textContent.replace(/[^\d,-]/g, '').replace(',', '.')) || 0,
                bezahlt: 0
            };
            currentZahlungRechnung.bezahlt = currentZahlungRechnung.brutto - currentZahlungRechnung.offen;

            // Modal befüllen
            document.getElementById('zahlungRechnungsnr').textContent = currentZahlungRechnung.rechnungsnummer;
            document.getElementById('zahlungRechnungsbetrag').textContent = formatCurrency(currentZahlungRechnung.brutto);
            document.getElementById('zahlungBereitsBezahlt').textContent = formatCurrency(currentZahlungRechnung.bezahlt);
            document.getElementById('zahlungOffen').textContent = formatCurrency(currentZahlungRechnung.offen);

            // Inputs zurücksetzen
            document.getElementById('zahlungBetrag').value = '';
            document.getElementById('zahlungDatum').value = new Date().toISOString().split('T')[0];
            document.getElementById('zahlungNotiz').value = '';
            updateZahlungVorschau();

            document.getElementById('zahlungModal').classList.add('active');
        }

        function closeZahlungModal() {
            document.getElementById('zahlungModal').classList.remove('active');
            currentZahlungRechnung = null;
        }

        function setZahlungVollstaendig() {
            if (!currentZahlungRechnung) return;
            document.getElementById('zahlungBetrag').value = currentZahlungRechnung.offen.toFixed(2);
            updateZahlungVorschau();
        }

        function updateZahlungVorschau() {
            const brutto = parseFloat(document.getElementById('zahlungBetrag').value) || 0;
            const netto = brutto / 1.19;
            const ust = brutto - netto;

            document.getElementById('zahlungVorschauNetto').textContent = formatCurrency(netto);
            document.getElementById('zahlungVorschauUst').textContent = formatCurrency(ust);
            document.getElementById('zahlungVorschauBrutto').textContent = formatCurrency(brutto);
        }

        async function saveZahlung() {
            if (!currentZahlungRechnung) return;

            const brutto = parseFloat(document.getElementById('zahlungBetrag').value) || 0;
            const datum = document.getElementById('zahlungDatum').value;
            const notiz = document.getElementById('zahlungNotiz').value.trim();

            if (brutto <= 0) {
                alert('Bitte einen gültigen Betrag eingeben');
                return;
            }
            if (!datum) {
                alert('Bitte ein Zahlungsdatum wählen');
                return;
            }

            const netto = brutto / 1.19;
            const ust = brutto - netto;

            try {
                // Zahlung in invoice_payments speichern
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/invoice_payments`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            invoice_id: currentZahlungRechnung.id,
                            betrag_netto: netto.toFixed(2),
                            betrag_ust: ust.toFixed(2),
                            betrag_brutto: brutto.toFixed(2),
                            zahlungsdatum: datum,
                            notiz: notiz || null
                        })
                    }
                );

                if (!res.ok) throw new Error('Zahlung konnte nicht gespeichert werden');

                // Prüfen ob Rechnung jetzt vollständig bezahlt
                const neuerOffenerBetrag = currentZahlungRechnung.offen - brutto;
                if (neuerOffenerBetrag <= 0.01) { // Toleranz für Rundungsfehler
                    // Status auf "bezahlt" setzen
                    const statusRes = await fetch(
                        `${SUPABASE_URL}/rest/v1/invoices?id=eq.${currentZahlungRechnung.id}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify({ status: 'bezahlt' })
                        }
                    );
                    if (statusRes.ok) {
                        alert('Zahlung gespeichert - Rechnung vollständig bezahlt');
                    }
                } else {
                    alert('Zahlung gespeichert');
                }

                closeZahlungModal();

                // Daten neu laden
                await loadDrkRechnungenFromDB();
                renderRechnungenTable();

                // Detail-Modal aktualisieren (falls offen)
                if (currentRechnungId) {
                    await loadRechnungDetails(currentRechnungId);
                }

            } catch (err) {
                console.error('Fehler beim Speichern der Zahlung:', err);
                alert('Fehler: ' + err.message);
            }
        }

        // ========== PDF-GENERIERUNG ==========

        function generateDrkInvoiceHTML(rechnung) {
            const r = rechnung;
            const calcData = r.calculation_data || {};

            // Datum formatieren
            const today = new Date();
            const rechnungsDatum = today.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });

            // Zeitraum formatieren
            const vonDate = r.period_start ? new Date(r.period_start) : null;
            const bisDate = r.period_end ? new Date(r.period_end) : null;
            const zeitraumText = vonDate && bisDate
                ? `${vonDate.toLocaleDateString('de-DE')} - ${bisDate.toLocaleDateString('de-DE')}`
                : '-';

            // Kundendaten
            const kundenName = r.customers?.full_name || r.customers?.name || 'Unbekannt';
            const kundenAdresse = r.customers?.adresse || {};
            const kundenStrasse = kundenAdresse.street ? `${kundenAdresse.street} ${kundenAdresse.houseNumber || ''}`.trim() : '';
            const kundenOrt = kundenAdresse.postalCode ? `${kundenAdresse.postalCode} ${kundenAdresse.city || ''}`.trim() : '';
            const kundenEmail = r.customers?.email || '';
            const kundenId = r.customers?.kunden_id || '-';

            // Abrechnungstyp
            const typMap = { 'ZA': 'Zwischenrechnung', 'EA': 'Endabrechnung', '1JA': '1. Jahresabrechnung', '2JA': '2. Jahresabrechnung', '3JA': '3. Jahresabrechnung', '4JA': '4. Jahresabrechnung' };
            let bezeichnung = typMap[r.abrechnungstyp] || 'Rechnung';
            if (r.ist_sondierung === true) bezeichnung += ' (Sonderkonditionen)';
            else if (r.ist_sondierung === false) bezeichnung += ' (Regularkonditionen)';

            // Beträge
            const zwischensumme = parseFloat(calcData.zwischensumme) || parseFloat(r.brutto_provision) || 0;
            const stornopuffer = parseFloat(calcData.stornopuffer) || 0;
            const netto = parseFloat(r.netto_auszahlung) || 0;
            const ust = parseFloat(r.vat_amount) || 0;
            const brutto = parseFloat(r.total_payout) || 0;

            // Positionen generieren
            let positionenHtml = '';
            let posNr = 1;

            if (calcData.positionen && Array.isArray(calcData.positionen)) {
                // Fall: Zusammen (mehrere Gebiete)
                calcData.positionen.forEach(p => {
                    const posCode = `A${posNr}`;
                    positionenHtml += `
                        <tr>
                            <td class="pos-nr">${posCode}</td>
                            <td class="pos-beschreibung">${p.gebietName || 'Neumitglieder'}<br><span class="pos-sub">${p.istSondierung ? 'Sonderkonditionen' : 'Regularkonditionen'}</span></td>
                            <td class="pos-right">${p.mg || 0}</td>
                            <td class="pos-right">${formatPdfEuro(p.je)}</td>
                            <td class="pos-right">${p.satz || 0}</td>
                            <td class="pos-right">${formatPdfEuro(p.betrag)}</td>
                        </tr>`;
                    posNr++;
                });
            } else if (calcData.gebiet) {
                // Fall: Getrennt (einzelnes Gebiet)
                if (calcData.mgSond > 0 || r.ist_sondierung === true) {
                    positionenHtml += `
                        <tr>
                            <td class="pos-nr">A1</td>
                            <td class="pos-beschreibung">Neumitglieder<br><span class="pos-sub">Sonderkonditionen</span></td>
                            <td class="pos-right">${calcData.mgSond || calcData.mg || 0}</td>
                            <td class="pos-right">${formatPdfEuro(calcData.jeSond || calcData.je || 0)}</td>
                            <td class="pos-right">${calcData.satzSond || calcData.satz || '-'}</td>
                            <td class="pos-right">${formatPdfEuro(calcData.sondBetrag || calcData.betrag || 0)}</td>
                        </tr>`;
                }
                if (calcData.mgReg > 0 || r.ist_sondierung === false) {
                    positionenHtml += `
                        <tr>
                            <td class="pos-nr">A${calcData.mgSond > 0 ? 2 : 1}</td>
                            <td class="pos-beschreibung">Neumitglieder<br><span class="pos-sub">Regularkonditionen</span></td>
                            <td class="pos-right">${calcData.mgReg || calcData.mg || 0}</td>
                            <td class="pos-right">${formatPdfEuro(calcData.jeReg || calcData.je || 0)}</td>
                            <td class="pos-right">${calcData.satzReg || calcData.satz || '-'}</td>
                            <td class="pos-right">${formatPdfEuro(calcData.regBetrag || calcData.betrag || 0)}</td>
                        </tr>`;
                }
            }

            // Stornopuffer-Zeile (nur bei ZA)
            let stornopufferHtml = '';
            if (stornopuffer > 0 && r.abrechnungstyp === 'ZA') {
                stornopufferHtml = `
                    <tr class="abzug-row">
                        <td class="pos-nr">B1</td>
                        <td class="pos-beschreibung">Stornopuffer -10%<br><span class="pos-sub">vertragliche Vereinbarung</span></td>
                        <td class="pos-right"></td>
                        <td class="pos-right"></td>
                        <td class="pos-right"></td>
                        <td class="pos-right text-red">-${formatPdfEuro(stornopuffer)}</td>
                    </tr>`;
            }

            return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Rechnung ${r.invoice_number || 'Entwurf'}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.4;
            color: #1a1a2e;
            background: #fff;
        }

        .invoice-page {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm 20mm;
            background: #fff;
            position: relative;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8mm;
            padding-bottom: 5mm;
            border-bottom: 2px solid #ffd700;
        }
        .logo-section {
            flex: 1;
        }
        .logo {
            font-size: 18pt;
            font-weight: 700;
            color: #1a1a2e;
            letter-spacing: 1px;
        }
        .logo-sub {
            font-size: 8pt;
            color: #6b7280;
            margin-top: 2mm;
        }
        .company-info {
            text-align: right;
            font-size: 8pt;
            color: #6b7280;
            line-height: 1.6;
        }
        .company-name {
            font-weight: 600;
            color: #1a1a2e;
            font-size: 10pt;
        }

        /* Absender/Empfänger */
        .address-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10mm;
        }
        .sender-line {
            font-size: 7pt;
            color: #9ca3af;
            text-decoration: underline;
            margin-bottom: 3mm;
        }
        .recipient {
            font-size: 10pt;
            line-height: 1.6;
        }
        .recipient-name {
            font-weight: 600;
        }

        /* Rechnungskopf */
        .invoice-header {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 5mm;
            border-radius: 3mm;
            margin-bottom: 8mm;
        }
        .invoice-title {
            font-size: 14pt;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 3mm;
        }
        .invoice-details {
            font-size: 9pt;
            line-height: 1.8;
        }
        .invoice-details strong {
            display: inline-block;
            width: 80px;
        }
        .contact-info {
            text-align: right;
            font-size: 8pt;
            color: #6b7280;
        }

        /* Bank & IDs */
        .bank-info {
            font-size: 8pt;
            color: #6b7280;
            margin-bottom: 2mm;
            padding: 3mm 5mm;
            background: #fefce8;
            border-left: 3px solid #ffd700;
        }
        .faelligkeit {
            font-size: 8pt;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 5mm;
        }

        /* Positionen-Tabelle */
        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 5mm;
            font-size: 9pt;
        }
        .positions-table th {
            background: #1a1a2e;
            color: #fff;
            padding: 3mm 2mm;
            text-align: left;
            font-weight: 600;
            font-size: 8pt;
        }
        .positions-table th:last-child,
        .positions-table th:nth-child(3),
        .positions-table th:nth-child(4),
        .positions-table th:nth-child(5) {
            text-align: right;
        }
        .positions-table td {
            padding: 3mm 2mm;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }
        .pos-nr {
            font-weight: 600;
            color: #6b7280;
            width: 30px;
        }
        .pos-beschreibung {
            width: 45%;
        }
        .pos-sub {
            font-size: 8pt;
            color: #9ca3af;
        }
        .pos-right {
            text-align: right;
        }
        .abzug-row td {
            background: #fef2f2;
        }
        .text-red {
            color: #dc2626;
        }

        /* Summen */
        .totals-section {
            margin-left: auto;
            width: 60%;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 2mm 3mm;
            font-size: 9pt;
        }
        .total-row.subtotal {
            border-top: 1px solid #e5e7eb;
            margin-top: 2mm;
        }
        .total-row.highlight {
            background: #fefce8;
            font-weight: 600;
        }
        .total-row.final {
            background: #1a1a2e;
            color: #fff;
            font-weight: 700;
            font-size: 11pt;
            margin-top: 2mm;
            border-radius: 2mm;
        }

        /* Footer */
        .footer {
            position: absolute;
            bottom: 15mm;
            left: 20mm;
            right: 20mm;
            border-top: 1px solid #e5e7eb;
            padding-top: 5mm;
            font-size: 7pt;
            color: #9ca3af;
            display: flex;
            justify-content: space-between;
        }
        .footer-col {
            flex: 1;
        }
        .footer-col:last-child {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="invoice-page">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">RHODENBURG</div>
                <div class="logo-sub">QP-Qualitätspartner der Gemeinwohl & Sozialwirtschaft</div>
            </div>
            <div class="company-info">
                <div class="company-name">RHODENBURG GmbH</div>
                Am Holzweg 27<br>
                50374 Erftstadt<br>
                <br>
                Tel: 02235 / 95 00 26 0<br>
                Fax: 02235 / 95 00 26 2<br>
                www.rhodenburg.de<br>
                buchhaltung@rhodenburg.de
            </div>
        </div>

        <!-- Absender/Empfänger -->
        <div class="address-section">
            <div class="recipient-block">
                <div class="sender-line">RHODENBURG GmbH · Am Holzweg 27 · 50374 Erftstadt</div>
                <div class="recipient">
                    <div class="recipient-name">${kundenName}</div>
                    ${kundenStrasse ? `${kundenStrasse}<br>` : ''}
                    ${kundenOrt ? `${kundenOrt}<br>` : ''}
                    ${kundenEmail ? `<br>E-Mail: ${kundenEmail}` : ''}
                </div>
            </div>
        </div>

        <!-- Rechnungskopf -->
        <div class="invoice-header">
            <div>
                <div class="invoice-title">Rechnung</div>
                <div class="invoice-details">
                    <strong>Bezeichnung:</strong> ${bezeichnung}<br>
                    <strong>Datum:</strong> ${rechnungsDatum}<br>
                    <strong>Nummer:</strong> ${r.invoice_number || '(Entwurf)'}<br>
                    <strong>Zeitraum:</strong> ${zeitraumText}
                </div>
            </div>
            <div class="contact-info">
                <strong>Ansprechpartner:</strong><br>
                Buchhaltung<br>
                buchhaltung@rhodenburg.de<br>
                <br>
                <strong>KD-ID:</strong> ${kundenId}<br>
                <strong>Vertr.-Nr.:</strong> ${r.vertragsnummer || '-'}
            </div>
        </div>

        <!-- Bank -->
        <div class="bank-info">
            <strong>Bankverbindung:</strong> DE53 1001 8000 0480 9659 32 (BIC: HLODDEHH)
        </div>
        <div class="faelligkeit">* sofortige Fälligkeit (sofern vertraglich nicht anders vereinbart)</div>

        <!-- Positionen -->
        <table class="positions-table">
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>Beschreibung</th>
                    <th>Anz MG</th>
                    <th>JE EUR</th>
                    <th>%</th>
                    <th>Gesamt</th>
                </tr>
            </thead>
            <tbody>
                ${positionenHtml}
                ${stornopufferHtml}
            </tbody>
        </table>

        <!-- Summen -->
        <div class="totals-section">
            <div class="total-row subtotal">
                <span>Zwischensumme EUR</span>
                <span>${formatPdfEuro(zwischensumme)}</span>
            </div>
            <div class="total-row highlight">
                <span>Gesamtsumme EUR</span>
                <span>${formatPdfEuro(netto)}</span>
            </div>
            <div class="total-row">
                <span>Gesetzl. USt (19%)</span>
                <span>${formatPdfEuro(ust)}</span>
            </div>
            <div class="total-row final">
                <span>RECHNUNGSBETRAG</span>
                <span>${formatPdfEuro(brutto)}</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-col">
                RHODENBURG GmbH<br>
                Am Holzweg 27, 50374 Erftstadt<br>
                Geschäftsführer: Lukas Rhodenburg
            </div>
            <div class="footer-col">
                Registergericht: Amtsgericht Köln<br>
                HRB 12345<br>
                USt-IdNr.: DE123456789
            </div>
            <div class="footer-col">
                Tel: 02235 / 95 00 26 0<br>
                www.rhodenburg.de<br>
                Seite 1 von 1
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        function formatPdfEuro(val) {
            return (parseFloat(val) || 0).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        async function generateDrkPDF(rechnung, output = 'download') {
            const html = generateDrkInvoiceHTML(rechnung);

            const opt = {
                margin: 0,
                filename: `Rechnung_${rechnung.invoice_number || 'Entwurf'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const element = document.createElement('div');
            element.innerHTML = html;
            document.body.appendChild(element);

            try {
                if (output === 'blob') {
                    const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
                    return pdfBlob;
                } else if (output === 'base64') {
                    // Für E-Mail-Anhang: Base64-String zurückgeben
                    const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            // Data URL: "data:application/pdf;base64,XXXX"
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(pdfBlob);
                    });
                } else {
                    await html2pdf().set(opt).from(element).save();
                }
            } finally {
                document.body.removeChild(element);
            }
        }

        async function downloadRechnungPdfModal() {
            if (!currentRechnungId || !currentRechnungData) return;

            try {
                // Kundendaten nachladen falls nicht vollständig
                if (!currentRechnungData.customers?.adresse) {
                    const res = await fetch(
                        `${SUPABASE_URL}/rest/v1/customers?select=*&id=eq.${currentRechnungData.customer_id}`,
                        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                    );
                    const kundenData = await res.json();
                    if (kundenData && kundenData.length > 0) {
                        currentRechnungData.customers = kundenData[0];
                    }
                }

                await generateDrkPDF(currentRechnungData, 'download');
            } catch (err) {
                console.error('Fehler beim PDF-Download:', err);
                alert('Fehler beim Erstellen des PDFs: ' + err.message);
            }
        }

        async function sendRechnungEmailModal() {
            if (!currentRechnungId || !currentRechnungData) return;

            try {
                // Bestätigung
                if (!confirm('Rechnung per E-Mail an den Schatzmeister senden?')) return;

                // Kundendaten nachladen falls nicht vollständig
                if (!currentRechnungData.customers?.adresse) {
                    const res = await fetch(
                        `${SUPABASE_URL}/rest/v1/customers?select=*&id=eq.${currentRechnungData.customer_id}`,
                        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                    );
                    const kundenData = await res.json();
                    if (kundenData && kundenData.length > 0) {
                        currentRechnungData.customers = kundenData[0];
                    }
                }

                // PDF als Base64 generieren
                const pdfBase64 = await generateDrkPDF(currentRechnungData, 'base64');
                const filename = `Rechnung_${currentRechnungData.invoice_number || 'Entwurf'}.pdf`;

                // Edge Function aufrufen
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/send-drk-invoice-email`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify({
                            invoice_id: currentRechnungId,
                            pdf_base64: pdfBase64,
                            pdf_filename: filename
                        })
                    }
                );

                const result = await response.json();

                if (result.success) {
                    alert(`E-Mail erfolgreich gesendet an: ${result.recipient}`);
                    // Rechnung neu laden
                    await loadRechnungDetails(currentRechnungId);
                    await loadRechnungen();
                } else {
                    alert('Fehler: ' + (result.error || 'Unbekannter Fehler'));
                }
            } catch (err) {
                console.error('Fehler beim E-Mail-Versand:', err);
                alert('Fehler beim E-Mail-Versand: ' + err.message);
            }
        }

        async function storniereRechnungModal() {
            if (!currentRechnungId) return;
            await storniereRechnung(currentRechnungId);
            closeRechnungDetailModal();
        }
    </script>
</body>
</html>
